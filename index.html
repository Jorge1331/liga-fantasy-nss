<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>LIGA FANTASY NSS 25/26</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- === Supabase: inicializaciÃ³n (no rompe tu UI) === -->
<script type="module">
  import { createClient } from "https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2.45.4/+esm";

  const SUPABASE_URL = "https://loywjhmhcevktcrdczss.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImxveXdqaG1oY2V2a3RjcmRjenNzIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTc0MzQ3ODAsImV4cCI6MjA3MzAxMDc4MH0.qXCHRxAezDs2UhwnpRLTCTzB2dwhckjykbmrrsUJqVQ";

  // Cliente global para usarlo luego: window.supa
  window.supa = createClient(SUPABASE_URL, SUPABASE_ANON_KEY, {
    auth: { persistSession: true, autoRefreshToken: true },
    global: { headers: { "x-application-name": "fantasy-nss" } },
  });

  // Helper para probar la conexiÃ³n sin tocar tu lÃ³gica
  window.FANTASY_DB = {
    async ping() {
      // intenta primero 'students' (que ya tienes) y luego 'classes'
      for (const t of ["students", "classes"]) {
        const { error } = await window.supa.from(t).select("id").limit(1);
        if (!error) return t; // devuelve el nombre de la tabla alcanzada
      }
      throw new Error("No pude leer 'students' ni 'classes'");
    },
  };

  console.debug("[FantasyNSS] Supabase inicializado:", SUPABASE_URL);
</script>
<!-- === Fin bloque Supabase === -->
  <style>
    :root {
      --color-primary:#1D4ED8;
      --color-dark:#000000;
      --color-light:#ffffff;
    }
    body {font-family:'Segoe UI',sans-serif;}
    .btn-primary {background:var(--color-primary);color:var(--color-light);} 
    .btn-primary:hover {background:#1746c5;}
    .hero-bg {
      background:linear-gradient(135deg,var(--color-primary) 0%,#0f1b3d 100%);
    }
    .skew-bottom {position:relative;}
    .skew-bottom::after{content:"";position:absolute;bottom:-1px;left:0;width:100%;height:80px;background:var(--color-light);transform:skewY(3deg);transform-origin:0;}

    /* ===== A11Y + CONTRASTE ===== */
    :focus-visible { outline: 3px solid var(--color-primary); outline-offset: 2px; border-radius: 10px; }
    button:focus-visible, a:focus-visible {
      box-shadow: 0 0 0 4px rgba(29,78,216,.35), 0 0 0 6px rgba(255,255,255,1);
    }

    /* TamaÃ±o tÃ¡ctil mÃ­nimo sin afectar a los botones pequeÃ±itos (.text-xs) */
    button:not(.text-xs) { min-height: 40px; min-width: 44px; }

    /* Tablas: encabezados con mÃ¡s contraste */
    table thead th { color: #0f172a; font-weight: 700; }

    /* Respeta usuarios con reduce-motion */
    @media (prefers-reduced-motion: reduce) {
      * { animation-duration: .001ms !important; transition-duration: .001ms !important; }
    }

    /* Chips de insignias (reutilizable) */
    .badge-chip {
      display:inline-flex; align-items:center; gap:6px;
      padding:2px 8px; border-radius:9999px; font-size:12px; line-height:1;
      background: #eef2ff; color:#3730a3; border:1px solid #c7d2fe;
    }
    .badge-chip[data-type="constancia"]    { background:#ecfeff; color:#0f766e; border-color:#99f6e4; }
    .badge-chip[data-type="companierismo"] { background:#fff7ed; color:#9a3412; border-color:#fed7aa; }
    .badge-chip[data-type="lectura"]       { background:#f0f9ff; color:#075985; border-color:#bae6fd; }
    .badge-chip .count { font-weight:700; font-size:11px; opacity:.85; }

    /* ===== Tiles del selector (serio + atractivo) ===== */
    .btn-tile{
      position:relative; display:flex; align-items:center; justify-content:center; gap:.6rem;
      width:100%; min-height:6.5rem; border-radius:1rem; padding:1rem 1.25rem;
      font-weight:700; color:#fff; letter-spacing:.2px;
      background:linear-gradient(135deg,#1d4ed8, #0ea5e9);
      box-shadow: 0 10px 24px rgba(2,6,23,.15), inset 0 0 0 1px rgba(255,255,255,.08);
      transition: transform .18s ease, box-shadow .18s ease, filter .18s ease;
    }
    .btn-tile:hover{ transform:translateY(-3px); box-shadow:0 16px 30px rgba(2,6,23,.22), inset 0 0 0 1px rgba(255,255,255,.14); filter:saturate(1.05);}
    .btn-tile:active{ transform:translateY(0); }
    .btn-tile::after{
      content:""; position:absolute; inset:0; border-radius:inherit; pointer-events:none;
      background:linear-gradient(120deg, rgba(255,255,255,.18), rgba(255,255,255,0) 40%);
      mix-blend-mode:overlay; opacity:.25; transition:opacity .2s ease;
    }
    .btn-tile:hover::after{ opacity:.35; }
    .btn-tile .icon{ font-size:1.25rem; opacity:.95; transform:translateY(1px); }

    /* Fondo suave detrÃ¡s del grid del selector */
    .selector-surface{ position:relative; }
    .selector-surface::before{
      content:""; position:absolute; inset:-12px; pointer-events:none; z-index:0;
      background:
        radial-gradient(900px 240px at 20% -5%, rgba(29,78,216,.08), transparent 60%),
        radial-gradient(700px 200px at 85% -5%, rgba(16,185,129,.08), transparent 55%);
    }
  </style>
</head>

<body class="min-h-screen bg-gray-100">
  <!-- Hero de Bienvenida -->
  <section id="intro" class="relative text-center text-white flex flex-col items-center justify-center min-h-screen px-6 overflow-hidden">
  <style>
    /* Estilos SOLO para #intro */
    #intro .bg-hero{
      position:absolute; inset:0; z-index:-1;
      background:
        radial-gradient(1200px 240px at -10% -30%, rgba(99,102,241,.18), transparent 60%),
        radial-gradient(1000px 220px at 110% -20%, rgba(16,185,129,.18), transparent 60%),
        linear-gradient(135deg, #1D4ED8 0%, #0f1b3d 100%);
    }
    /* Sutil rejilla â€œgamingâ€ */
    #intro .grid-mask::before{
      content:""; position:absolute; inset:0; z-index:-1;
      background-image:
        linear-gradient(to right, rgba(255,255,255,.06) 1px, transparent 1px),
        linear-gradient(to bottom, rgba(255,255,255,.06) 1px, transparent 1px);
      background-size: 28px 28px;
      mask-image: radial-gradient(closest-side, rgba(255,255,255,.9), transparent);
      opacity:.35;
    }
    /* Orbes suaves */
    #intro .orb{ position:absolute; filter: blur(24px); opacity:.35; border-radius:9999px; }
    #intro .orb.o1{ width:280px; height:280px; left:-60px; top:10%; background:#60a5fa; }
    #intro .orb.o2{ width:220px; height:220px; right:-40px; top:18%; background:#34d399; }
    /* BotÃ³n principal con leve latido */
    #intro .btn-hero{ background:#1D4ED8; }
    #intro .btn-hero:hover{ background:#1746c5; transform: translateY(-2px); }
    #intro .pulse{ animation: pulse 2.2s ease-in-out infinite; }
    @keyframes pulse{ 0%,100%{ box-shadow:0 0 0 0 rgba(29,78,216,.45);} 50%{ box-shadow:0 0 0 18px rgba(29,78,216,0);} }
    /* Tarjetas/chips informativas */
    #intro .chip{
      background: linear-gradient(180deg, rgba(255,255,255,.16) 0%, rgba(255,255,255,.08) 100%);
      border:1px solid rgba(255,255,255,.18);
      backdrop-filter: blur(4px);
    }
    /* Ola inferior */
    #intro svg.wave{ position:absolute; bottom:0; left:0; width:100%; }
  </style>

  <!-- Fondo -->
  <div class="bg-hero grid-mask"></div>
  <div class="orb o1"></div>
  <div class="orb o2"></div>

  <!-- Logo + TÃ­tulo + Frase (sin cambios de texto) -->
  <img src="images/logo.png" alt="Logo Colegio" class="w-40 md:w-48 mb-8 drop-shadow-lg" />
  <h1 class="text-4xl md:text-5xl font-extrabold tracking-wide mb-4">LIGA FANTASY NSS 25/26</h1>
  <p class="text-lg md:text-xl mb-8 max-w-2xl mx-auto text-white/90">Â¡Motivando el aprendizaje con espÃ­ritu competitivo y trabajo en equipo!</p>

  <!-- Chips informativas -->
  <div class="grid grid-cols-1 sm:grid-cols-3 gap-3 w-full max-w-4xl mb-8">
    <div class="chip rounded-2xl px-4 py-3 text-left">
      <p class="text-sm text-white/80">Clases</p>
      <p class="text-xl font-bold">5ÂºA Â· 5ÂºB Â· 6ÂºA Â· 6ÂºB</p>
    </div>
    <div class="chip rounded-2xl px-4 py-3 text-left">
      <p class="text-sm text-white/80">DinÃ¡mica</p>
      <p class="text-xl font-bold">Puntos + Recompensas</p>
    </div>
    <div class="chip rounded-2xl px-4 py-3 text-left">
      <p class="text-sm text-white/80">ParticipaciÃ³n</p>
      <p class="text-xl font-bold">GalerÃ­a & Entrevistas</p>
    </div>
  </div>

  <!-- CTA principal (solo uno) -->
  <button onclick="startApp()" class="btn-hero pulse px-8 py-3 rounded-full text-lg font-semibold shadow-xl transition">
    Entrar a la Liga
  </button>

  <!-- Ola inferior -->
  <svg class="wave" viewBox="0 0 1440 100" preserveAspectRatio="none" aria-hidden="true">
    <path fill="#ffffff" d="M0,64L80,69.3C160,75,320,85,480,85.3C640,85,800,75,960,69.3C1120,64,1280,64,1360,64L1440,64L1440,100L1360,100C1280,100,1120,100,960,100C800,100,640,100,480,100C320,100,160,100,80,100L0,100Z"></path>
  </svg>
</section>

  <!-- App Principal -->
  <div id="mainApp" class="hidden flex flex-col min-h-screen">
    <!-- Header -->
    <header class="bg-white shadow sticky top-0 z-20">
      <div class="max-w-6xl mx-auto flex items-center justify-between py-3 px-4">
        <div class="flex items-center space-x-4">
          <img src="images/logo.png" alt="Logo" class="h-10"/>
          <h2 class="text-2xl font-bold text-gray-900">LIGA FANTASY NSS 25/26</h2>
        </div>
        <button onclick="goHome()" class="btn-primary px-4 py-1 rounded">Inicio</button>
      </div>
    </header>

 <!-- Pantalla de SelecciÃ³n (rediseÃ±ada) -->
    <section id="selector"
      class="selector-surface flex-1 grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 gap-6 p-6 place-items-center">

      <button class="btn-tile bg-gradient-to-br from-blue-600 to-indigo-600 focus-visible:outline-white"
              onclick="showSection('5a')" aria-label="Abrir Clase 5A">
        <span class="icon">ğŸ«</span> Clase 5ÂºA
      </button>

      <button class="btn-tile bg-gradient-to-br from-blue-600 to-sky-600 focus-visible:outline-white"
              onclick="showSection('5b')" aria-label="Abrir Clase 5B">
        <span class="icon">ğŸ«</span> Clase 5ÂºB
      </button>

      <button class="btn-tile bg-gradient-to-br from-blue-600 to-indigo-600 focus-visible:outline-white"
              onclick="showSection('6a')" aria-label="Abrir Clase 6A">
        <span class="icon">ğŸ«</span> Clase 6ÂºA
      </button>

      <button class="btn-tile bg-gradient-to-br from-blue-600 to-sky-600 focus-visible:outline-white"
              onclick="showSection('6b')" aria-label="Abrir Clase 6B">
        <span class="icon">ğŸ«</span> Clase 6ÂºB
      </button>

      <button class="btn-tile bg-gradient-to-br from-slate-800 to-slate-900 focus-visible:outline-white"
              onclick="showSection('objetivos')" aria-label="Ver Objetivos">
        <span class="icon">ğŸ¯</span> Objetivos
      </button>

      <button class="btn-tile bg-gradient-to-br from-emerald-600 to-teal-600 focus-visible:outline-white"
              onclick="showSection('recompensas')" aria-label="Ver Recompensas">
        <span class="icon">ğŸ</span> Recompensas
      </button>

      <!-- Entrevistas: debajo de Objetivos -->
      <button class="btn-tile bg-gradient-to-br from-orange-600 to-amber-600 sm:col-start-1 md:col-start-2 focus-visible:outline-white"
              onclick="showSection('entrevistas')" aria-label="Ver Entrevistas">
        <span class="icon">ğŸ¤</span> Entrevistas
      </button>
    </section>

    <!-- NavegaciÃ³n superior clÃ¡sica -->
    <nav id="nav-top" class="hidden bg-gray-200">
      <div class="max-w-6xl mx-auto flex flex-wrap justify-center gap-2 py-2">
        <button class="tab-btn btn-primary px-4 py-1 rounded" onclick="showSection('5a')">5ÂºA</button>
        <button class="tab-btn btn-primary px-4 py-1 rounded" onclick="showSection('5b')">5ÂºB</button>
        <button class="tab-btn btn-primary px-4 py-1 rounded" onclick="showSection('6a')">6ÂºA</button>
        <button class="tab-btn btn-primary px-4 py-1 rounded" onclick="showSection('6b')">6ÂºB</button>
        <button class="tab-btn bg-gray-800 text-white px-4 py-1 rounded" onclick="showSection('objetivos')">Objetivos</button>
        <button class="tab-btn bg-gray-800 text-white px-4 py-1 rounded" onclick="showSection('recompensas')">Recompensas</button>
        <button class="tab-btn bg-orange-600 text-white px-4 py-1 rounded" onclick="showSection('entrevistas')">Entrevistas</button>
      </div>
    </nav>
    <!-- Contenido -->
    <main class="flex-1 max-w-6xl mx-auto w-full p-4">
   <section id="5a" class="hidden">
  <!-- 5ÂºA: Panel de clase (autosuficiente y aislado) -->
  <div class="flex flex-col gap-4">
    <!-- Encabezado + Acciones -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div>
        <h3 class="text-3xl font-extrabold tracking-tight">Clase 5ÂºA</h3>
        <p class="text-sm text-gray-600">Temporada 25/26 Â· GestiÃ³n local (solo en este dispositivo)</p>
      </div>
      <div class="flex flex-wrap gap-2">
        <button id="c5a-btn-mvp" class="px-4 py-2 rounded-lg bg-purple-600 text-white hover:bg-purple-700 shadow">ğŸ² Sorteo MVP</button>
        <button id="c5a-btn-reset" class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 shadow">ğŸ§¹ Reset puntos</button>
        <button id="c5a-btn-edit" class="px-4 py-2 rounded-lg bg-gray-900 text-white hover:bg-black shadow">âœï¸ Editar lista</button>
      </div>
    </div>

    <!-- Tarjetas de mÃ©tricas -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
      <div class="bg-white shadow rounded-xl p-4">
        <p class="text-xs text-gray-500">Alumnos</p>
        <p id="c5a-metric-count" class="text-2xl font-bold">â€”</p>
      </div>
      <div class="bg-white shadow rounded-xl p-4">
        <p class="text-xs text-gray-500">Puntos totales</p>
        <p id="c5a-metric-total" class="text-2xl font-bold">â€”</p>
      </div>
      <div class="bg-white shadow rounded-xl p-4">
        <p class="text-xs text-gray-500">Media</p>
        <p id="c5a-metric-avg" class="text-2xl font-bold">â€”</p>
      </div>
      <div class="bg-white shadow rounded-xl p-4">
        <p class="text-xs text-gray-500">LÃ­der</p>
        <p id="c5a-metric-leader" class="text-sm font-semibold">â€”</p>
      </div>
    </div>

    <!-- Podio -->
    <div class="grid md:grid-cols-3 gap-3">
      <div class="bg-white shadow rounded-xl p-4 border-t-4 border-amber-400">
        <p class="text-sm text-gray-500">ğŸ¥‡ 1Âº</p>
        <p id="c5a-p1" class="font-bold">â€”</p>
        <p id="c5a-p1p" class="text-sm text-gray-700">â€” pts</p>
      </div>
      <div class="bg-white shadow rounded-xl p-4 border-t-4 border-gray-400">
        <p class="text-sm text-gray-500">ğŸ¥ˆ 2Âº</p>
        <p id="c5a-p2" class="font-bold">â€”</p>
        <p id="c5a-p2p" class="text-sm text-gray-700">â€” pts</p>
      </div>
      <div class="bg-white shadow rounded-xl p-4 border-t-4 border-orange-400">
        <p class="text-sm text-gray-500">ğŸ¥‰ 3Âº</p>
        <p id="c5a-p3" class="font-bold">â€”</p>
        <p id="c5a-p3p" class="text-sm text-gray-700">â€” pts</p>
      </div>
    </div>

    <!-- MVP de la semana -->
    <div class="bg-gradient-to-r from-indigo-600 to-blue-600 text-white rounded-xl p-4 shadow flex items-center justify-between">
      <div>
        <p class="text-sm opacity-90">Jugador/a de la semana</p>
        <p id="c5a-mvp-name" class="text-xl font-extrabold">AÃºn sin elegir</p>
      </div>
      <div class="text-right">
        <p id="c5a-mvp-points" class="text-sm opacity-90">â€” pts</p>
        <button id="c5a-btn-clear-mvp" class="mt-2 px-3 py-1 rounded bg-white/15 hover:bg-white/25">Quitar MVP</button>
      </div>
    </div>

    <!-- Registro rÃ¡pido de objetivos -->
    <div class="bg-white shadow rounded-xl p-4">
      <h4 class="font-semibold mb-3">Registrar objetivo rÃ¡pido</h4>
      <div class="flex flex-col md:flex-row gap-2 items-stretch md:items-center">
        <select id="c5a-quick-student" class="border rounded-lg px-3 py-2 flex-1"></select>
        <select id="c5a-quick-reason" class="border rounded-lg px-3 py-2">
          <option value="1">ğŸ“š Entrega de tareas (+1)</option>
          <option value="1">ğŸ™Œ Buena acciÃ³n (+1)</option>
          <option value="3">ğŸ“– Libro extra (+3)</option>
          <option value="-1">âŒ Falta de trabajo (-1)</option>
          <option value="-3">ğŸš« Incidencia grave (-3)</option>
        </select>
        <button id="c5a-quick-apply" class="btn-primary px-4 py-2 rounded-lg">Aplicar</button>
      </div>
    </div>

    <!-- Semana en curso (Lâ€“V) -->
    <div id="c5a-week" class="bg-white shadow rounded-xl p-4">
      <div class="flex items-center justify-between">
        <p class="font-semibold" id="c5a-period-title">Mes en curso</p>
        <p id="c5a-week-label" class="text-sm text-gray-500">0%</p>
      </div>
      <div class="h-3 bg-gray-100 rounded-full mt-2 overflow-hidden">
        <div id="c5a-week-bar" class="h-3 bg-gradient-to-r from-indigo-500 to-blue-500" style="width:0%"></div>
      </div>
      <div class="flex gap-1 mt-2" id="c5a-week-days">
        <span data-i="0" class="px-2 py-0.5 text-xs rounded bg-gray-100 text-gray-600">L</span>
        <span data-i="1" class="px-2 py-0.5 text-xs rounded bg-gray-100 text-gray-600">M</span>
        <span data-i="2" class="px-2 py-0.5 text-xs rounded bg-gray-100 text-gray-600">X</span>
        <span data-i="3" class="px-2 py-0.5 text-xs rounded bg-gray-100 text-gray-600">J</span>
        <span data-i="4" class="px-2 py-0.5 text-xs rounded bg-gray-100 text-gray-600">V</span>
      </div>
      <div id="c5a-reset-alert" class="hidden mt-3 px-3 py-2 rounded-lg bg-amber-50 text-amber-800 border border-amber-200 text-sm">
        Hace <span id="c5a-days-since">â€”</span> dÃ­as del Ãºltimo reinicio. Considera usar â€œReset puntosâ€.
      </div>
    </div>

    <!-- Leyenda de insignias -->
    <div class="bg-white shadow rounded-xl p-4">
      <p class="text-sm font-semibold mb-2">Insignias disponibles</p>
      <div class="flex flex-wrap gap-2">
        <span class="badge-chip" data-type="constancia">â­ Constancia <span class="count">+1</span></span>
        <span class="badge-chip" data-type="companierismo">ğŸ¤ CompaÃ±erismo <span class="count">+1</span></span>
        <span class="badge-chip" data-type="lectura">ğŸ“– Lectura <span class="count">+1</span></span>
      </div>
    </div>

    <!-- Tabla de clasificaciÃ³n -->
    <div class="overflow-x-auto bg-white shadow rounded-xl">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-4 py-2 text-left text-xs font-medium uppercase">#</th>
            <th class="px-4 py-2 text-left text-xs font-medium uppercase">Alumno</th>
            <th class="px-4 py-2 text-left text-xs font-medium uppercase">Puntos</th>
            <th class="px-4 py-2 text-left text-xs font-medium uppercase">Insignias</th>
            <th class="px-4 py-2"></th>
          </tr>
        </thead>
        <tbody id="c5a-tbody" class="divide-y divide-gray-200"></tbody>
      </table>
    </div>

    <!-- Editor de lista -->
    <div id="c5a-editor" class="hidden bg-white shadow rounded-xl p-4">
      <h4 class="font-semibold mb-2">Editar lista de alumnos</h4>
      <p class="text-sm text-gray-600 mb-3">Escribe un nombre por lÃ­nea. <strong>Se reiniciarÃ¡n los puntos</strong> al aplicar cambios.</p>
      <textarea id="c5a-textarea" class="w-full h-40 border rounded-lg p-3 font-mono text-sm"></textarea>
      <div class="mt-3 flex gap-2">
        <button id="c5a-editor-apply" class="px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">Aplicar cambios</button>
        <button id="c5a-editor-cancel" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- LÃ³gica ESPECÃFICA de 5ÂºA (aislada) -->
  <script>
(function(){
  const sec = document.getElementById('5a');
  const KEY       = 'fantasy_5a_roster_v1';
  const KEY_MVP   = 'fantasy_5a_mvp_v1';
  const KEY_RESET = 'fantasy_5a_last_reset_v1';

  const defaultNames = [
    'Ãlvaro','LucÃ­a','MartÃ­n','SofÃ­a','Leo','Daniela','Mateo','Emma','Hugo','Valeria',
    'Lucas','Carla','Pablo','Julia','Enzo','Martina','Alejandro','Paula','Manuel','Sara',
    'AdriÃ¡n','Noa','David','Chloe','Mario'
  ];

  const $ = (sel)=>sec.querySelector(sel);

  /* ----------------- Storage ----------------- */
  function load(){
    try{ const raw = localStorage.getItem(KEY); if(raw) return JSON.parse(raw); }catch(e){}
    return defaultNames.map(n=>({ name:n, points:0 }));
  }
  function save(){ localStorage.setItem(KEY, JSON.stringify(roster)); }

  function loadMvp(){
    try{ const raw = localStorage.getItem(KEY_MVP); if(raw) return JSON.parse(raw); }catch(e){}
    return null;
  }
  function saveMvp(mvp){
    if(mvp) localStorage.setItem(KEY_MVP, JSON.stringify(mvp));
    else localStorage.removeItem(KEY_MVP);
  }

  /* ---------- Progreso semanal / reset ---------- */
  function getLastReset(){ const v = localStorage.getItem(KEY_RESET); return v? parseInt(v,10): null; }
  function setLastReset(ts){ localStorage.setItem(KEY_RESET, String(ts)); }
  function getWeekBounds(){
    const now = new Date();
    const d = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const mondayOffset = (d.getDay()+6)%7;
    const start = new Date(d); start.setDate(d.getDate()-mondayOffset); start.setHours(0,0,0,0);
    const end   = new Date(start); end.setDate(start.getDate()+4); end.setHours(23,59,59,999);
    return { now, start, end };
  }
 // AÃ±ade esta helper dentro del IIFE (si no existe):
function capitalize(str){ return str.charAt(0).toUpperCase() + str.slice(1); }
// Sustituye COMPLETA tu funciÃ³n renderProgress() por esta:
function renderProgress(){
  const bar     = $('#c5a-week-bar');      // reutilizamos la barra existente
  const label   = $('#c5a-week-label');    // reutilizamos el % existente
  const titleEl = $('#c5a-period-title');  // nuevo tÃ­tulo "Mes en curso"
  const chips   = $('#c5a-week-days');     // ocultamos L-M-X-J-V
  const alert   = $('#c5a-reset-alert');
  const daysSpan= $('#c5a-days-since');

  // === Mes en curso: anclado a OCT-2025 hasta 1 NOV 2025; luego dinÃ¡mico ===
  const now = new Date();
  let start, end;

  if (now < new Date(2025, 10, 1)) { // 1 nov 2025 (mes 10 porque empieza en 0)
    start = new Date(2025, 9, 1, 0,0,0,0);          // 1 oct 2025
    end   = new Date(2025,10, 0,23,59,59,999);      // 31 oct 2025
  } else {
    start = new Date(now.getFullYear(), now.getMonth(), 1, 0,0,0,0);
    end   = new Date(now.getFullYear(), now.getMonth()+1, 0,23,59,59,999);
  }

  const total = Math.max(1, end - start);
  let pct = 0;
  if (now <= start) pct = 0;
  else if (now >= end) pct = 1;
  else pct = (now - start) / total;

  if (bar)   bar.style.width = (pct*100).toFixed(0)+'%';
  if (label) label.textContent = (pct*100).toFixed(0)+'%';

  const mesTxt = start.toLocaleDateString('es-ES', { month:'long', year:'numeric' });
  if (titleEl) titleEl.textContent = `Mes en curso: ${capitalize(mesTxt)}`;

  if (chips) chips.classList.add('hidden'); // ocultar L-M-X-J-V

  // Aviso de reset: lo dejo igual que tenÃ­as
  if(!alert) return;
  const last = getLastReset();
  if(last){
    const days = Math.floor((Date.now()-last)/(1000*60*60*24));
    if(daysSpan) daysSpan.textContent = String(days);
    alert.classList.toggle('hidden', days<7);
  }else{
    alert.classList.remove('hidden');
    alert.innerHTML = 'AÃºn no se ha reiniciado esta clase. Usa <strong>â€œReset puntosâ€</strong> al final de la semana.';
  }
}
  /* --------------------------------------------- */

  /* ---------- Insignias / Badges ---------- */
  function ensureBadges(){ roster.forEach(a=>{ if(!Array.isArray(a.badges)) a.badges = []; }); }
  const BADGE_TYPES = [
    { key:'constancia',    icon:'â­', label:'Constancia' },
    { key:'companierismo', icon:'ğŸ¤', label:'CompaÃ±erismo' },
    { key:'lectura',       icon:'ğŸ“–', label:'Lectura' },
  ];
  // Cada insignia aporta puntos (ajusta a 0 si las quieres solo visuales)
  const BADGE_POINTS = { constancia:1, companierismo:1, lectura:1 };

  function groupBadges(arr){
    const map = { constancia:0, companierismo:0, lectura:0 };
    if(Array.isArray(arr)) arr.forEach(k=>{ if(map[k]!==undefined) map[k]++; });
    return map;
  }
  function badgesHTML(a){
    const map = groupBadges(a.badges || []);
    const parts = [];
    BADGE_TYPES.forEach(t=>{
      if(map[t.key]>0){
        parts.push(`<span class="badge-chip" data-type="${t.key}">${t.icon} ${t.label} <span class="count">x${map[t.key]}</span></span>`);
      }
    });
    return parts.join(' ');
  }
  function adjustPointsByBadgeMap(idx, map, sign = +1){
    Object.keys(map).forEach(k=>{
      const inc = (BADGE_POINTS[k] || 0) * (map[k] || 0) * sign;
      if(inc) roster[idx].points = Math.max(0, roster[idx].points + inc);
    });
  }

  // MenÃº inline de insignias (no se corta por overflow)
  function openBadgePicker(anchor, idx){
    const cell = anchor.closest('td');
    if(!cell) return;
    closeBadgePicker(); // cierra cualquier menÃº previo en 5ÂºA

    cell.classList.add('relative');
    const pop = document.createElement('div');
    pop.id = 'c5a-badge-pop';
    pop.className = 'absolute right-0 top-full mt-1 z-50 bg-white shadow-xl border border-gray-200 rounded-xl p-2 w-44';

    BADGE_TYPES.forEach(t=>{
      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'px-3 py-2 rounded hover:bg-gray-100 flex items-center gap-2 w-full text-sm';
      b.innerHTML = `<span>${t.icon}</span><span>${t.label}</span>`;
      b.addEventListener('click', (ev)=>{
        ev.stopPropagation();
        addBadge(idx, t.key);
        closeBadgePicker();
      });
      pop.appendChild(b);
    });

    const hr = document.createElement('div');
    hr.className='my-1 border-t border-gray-200';
    pop.appendChild(hr);

    const clear = document.createElement('button');
    clear.type = 'button';
    clear.className='px-3 py-2 rounded bg-amber-50 hover:bg-amber-100 text-amber-700 w-full text-sm';
    clear.textContent = 'ğŸ§¹ Quitar todas';
    clear.addEventListener('click', (ev)=>{
      ev.stopPropagation();
      const current = groupBadges(roster[idx].badges || []);
      adjustPointsByBadgeMap(idx, current, -1); // restar lo ganado por badges
      roster[idx].badges = [];
      save(); renderAll(); closeBadgePicker();
    });
    pop.appendChild(clear);

    cell.appendChild(pop);

    // Cerrar al hacer click fuera
    const outside = (e)=>{
      if(!pop.contains(e.target)){
        document.removeEventListener('click', outside);
        closeBadgePicker();
      }
    };
    setTimeout(()=> document.addEventListener('click', outside), 0);
  }
  function closeBadgePicker(){
    const el = document.getElementById('c5a-badge-pop');
    if(el) el.remove();
  }
  function addBadge(idx, key){
    ensureBadges();
    roster[idx].badges.push(key);
    const inc = BADGE_POINTS[key] || 0;
    if(inc){ roster[idx].points = Math.max(0, roster[idx].points + inc); }
    save();
    renderAll();
  }
  /* --------------------------------------- */

  /* ----------------- Estado ----------------- */
  let roster = load();
  let mvp    = loadMvp();
  ensureBadges();

  /* --------------- Render helpers --------------- */
  function sortRoster(){ roster.sort((a,b)=> b.points - a.points || a.name.localeCompare(b.name)); }
  function stats(){
    const count = roster.length;
    const total = roster.reduce((s,a)=>s+a.points,0);
    const avg = count? (total/count).toFixed(1) : '0.0';
    const leader = roster[0]? roster[0].name+' ('+roster[0].points+')':'â€”';
    $('#c5a-metric-count').textContent  = count;
    $('#c5a-metric-total').textContent  = total;
    $('#c5a-metric-avg').textContent    = avg;
    $('#c5a-metric-leader').textContent = leader;
  }
  function renderPodium(){
    const p1 = roster[0], p2 = roster[1], p3 = roster[2];
    $('#c5a-p1').textContent  = p1? p1.name : 'â€”';
    $('#c5a-p1p').textContent = p1? p1.points+' pts':'â€” pts';
    $('#c5a-p2').textContent  = p2? p2.name : 'â€”';
    $('#c5a-p2p').textContent = p2? p2.points+' pts':'â€” pts';
    $('#c5a-p3').textContent  = p3? p3.name : 'â€”';
    $('#c5a-p3p').textContent = p3? p3.points+' pts':'â€” pts';
  }
  function renderMvp(){
    if(mvp){ $('#c5a-mvp-name').textContent = mvp.name; $('#c5a-mvp-points').textContent = mvp.points+' pts'; }
    else { $('#c5a-mvp-name').textContent = 'AÃºn sin elegir'; $('#c5a-mvp-points').textContent = 'â€” pts'; }
  }
  function renderSelects(){
    const sel = $('#c5a-quick-student'); if(!sel) return;
    sel.innerHTML = '';
    roster.forEach((a,idx)=>{
      const opt = document.createElement('option');
      opt.value = idx; opt.textContent = a.name;
      sel.appendChild(opt);
    });
  }
  function renderTable(){
    const tbody = $('#c5a-tbody'); if(!tbody) return;
    tbody.innerHTML = '';
    roster.forEach((a,idx)=>{
      const tr = document.createElement('tr');
      tr.className = (mvp && mvp.name===a.name) ? 'bg-amber-50' : '';
      tr.innerHTML = `
        <td class="px-4 py-2 text-sm text-gray-700">${idx+1}</td>
        <td class="px-4 py-2 text-sm font-medium text-gray-900">${a.name}</td>
        <td class="px-4 py-2 text-sm text-gray-700">${a.points}</td>
        <td class="px-4 py-2 text-sm space-x-1">${badgesHTML(a) || '<span class="text-xs text-gray-400">â€”</span>'}</td>
        <td class="px-4 py-2 flex gap-1">
          <button class="btn-primary text-xs px-2 py-1 rounded" data-action="plus" data-index="${idx}">+1</button>
          <button class="bg-red-600 text-white text-xs px-2 py-1 rounded" data-action="minus" data-index="${idx}">-1</button>
          <button class="bg-amber-500 text-white text-xs px-2 py-1 rounded" data-action="star" data-index="${idx}">â­ MVP</button>
          <button class="bg-gray-800 text-white text-xs px-2 py-1 rounded" data-action="badge" data-index="${idx}">ğŸ…</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }
  function renderEditor(){
    const ta = $('#c5a-textarea'); if(!ta) return;
    ta.value = roster.map(a=>a.name).join('\n');
  }

  function renderAll(){
    sortRoster(); stats(); renderPodium(); renderMvp(); renderSelects(); renderTable(); renderProgress();
  }

  /* ----------------- Eventos ----------------- */
  const qaBtn = $('#c5a-quick-apply');
  if(qaBtn){
    qaBtn.addEventListener('click', ()=>{
      const idx = parseInt($('#c5a-quick-student').value,10);
      const delta = parseInt($('#c5a-quick-reason').value,10);
      if(isNaN(idx)||isNaN(delta)) return;
      roster[idx].points = Math.max(0, roster[idx].points + delta);
      save(); renderAll();
    });
  }

  const mvpBtn = $('#c5a-btn-mvp');
  if(mvpBtn){
    mvpBtn.addEventListener('click', ()=>{
      if(!roster.length) return;
      const idx = Math.floor(Math.random()*roster.length);
      mvp = { name: roster[idx].name, points: roster[idx].points };
      saveMvp(mvp); renderAll();
    });
  }

  const mvpClear = $('#c5a-btn-clear-mvp');
  if(mvpClear){ mvpClear.addEventListener('click', ()=>{ mvp=null; saveMvp(null); renderAll(); }); }

  const resetBtn = $('#c5a-btn-reset');
  if(resetBtn){
    resetBtn.addEventListener('click', ()=>{
      if(confirm('Â¿Seguro que quieres poner a 0 todos los puntos de 5ÂºA?')){
        roster = roster.map(a=>({name:a.name, points:0, badges:[]}));
        mvp=null; save(); saveMvp(null);
        setLastReset(Date.now());
        renderAll();
      }
    });
  }

  const tbody = $('#c5a-tbody');
  if(tbody){
    tbody.addEventListener('click', (e)=>{
      const btn = e.target.closest('button'); if(!btn) return;
      const idx = parseInt(btn.getAttribute('data-index'),10);
      const action = btn.getAttribute('data-action'); if(Number.isNaN(idx)) return;

      if(action==='plus'){ roster[idx].points = Math.max(0, roster[idx].points + 1); }
      if(action==='minus'){
        roster[idx].points = Math.max(0, roster[idx].points - 1);
        const row = btn.closest('tr'); row?.classList.add('shake'); setTimeout(()=> row?.classList.remove('shake'), 220);
      }
      if(action==='star'){ mvp = { name: roster[idx].name, points: roster[idx].points }; saveMvp(mvp); }
      if(action==='badge'){ openBadgePicker(btn, idx); return; } // no guardes aÃºn, abre menÃº

      save(); renderAll();
    });
  }

  const editor = $('#c5a-editor');
  const editBtn = $('#c5a-btn-edit');
  const edCancel = $('#c5a-editor-cancel');
  const edApply  = $('#c5a-editor-apply');

  if(editBtn){ editBtn.addEventListener('click', ()=>{ editor.classList.toggle('hidden'); renderEditor(); }); }
  if(edCancel){ edCancel.addEventListener('click', ()=> editor.classList.add('hidden')); }
  if(edApply){
    edApply.addEventListener('click', ()=>{
      const lines = $('#c5a-textarea').value.split('\n').map(s=>s.trim()).filter(Boolean);
      if(!lines.length) return;
      roster = lines.map(n=>({ name:n, points:0, badges:[] }));
      mvp=null; save(); saveMvp(null);
      editor.classList.add('hidden'); renderAll();
    });
  }

  // Render SOLO cuando la secciÃ³n estÃ© visible
  const obs = new MutationObserver(()=>{ if(!sec.classList.contains('hidden')) renderAll(); });
  obs.observe(sec, { attributes:true });
  if(!sec.classList.contains('hidden')) renderAll();
})();
</script>
</section>
      <section id="5b" class="hidden">
  <!-- 5ÂºB: Panel de clase (aislado) -->
  <div class="flex flex-col gap-4">
    <!-- Encabezado + Acciones -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div>
        <h3 class="text-3xl font-extrabold tracking-tight">Clase 5ÂºB</h3>
        <p class="text-sm text-gray-600">Temporada 25/26 Â· GestiÃ³n local (solo en este dispositivo)</p>
      </div>
      <div class="flex flex-wrap gap-2">
        <button id="c5b-btn-mvp" class="px-4 py-2 rounded-lg bg-teal-600 text-white hover:bg-teal-700 shadow">ğŸ² Sorteo MVP</button>
        <button id="c5b-btn-reset" class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 shadow">ğŸ§¹ Reset puntos</button>
        <button id="c5b-btn-edit" class="px-4 py-2 rounded-lg bg-gray-900 text-white hover:bg-black shadow">âœï¸ Editar lista</button>
      </div>
    </div>

    <!-- Tarjetas de mÃ©tricas -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
      <div class="bg-white shadow rounded-xl p-4">
        <p class="text-xs text-gray-500">Alumnos</p>
        <p id="c5b-metric-count" class="text-2xl font-bold">â€”</p>
      </div>
      <div class="bg-white shadow rounded-xl p-4">
        <p class="text-xs text-gray-500">Puntos totales</p>
        <p id="c5b-metric-total" class="text-2xl font-bold">â€”</p>
      </div>
      <div class="bg-white shadow rounded-xl p-4">
        <p class="text-xs text-gray-500">Media</p>
        <p id="c5b-metric-avg" class="text-2xl font-bold">â€”</p>
      </div>
      <div class="bg-white shadow rounded-xl p-4">
        <p class="text-xs text-gray-500">LÃ­der</p>
        <p id="c5b-metric-leader" class="text-sm font-semibold">â€”</p>
      </div>
    </div>

    <!-- Podio -->
    <div class="grid md:grid-cols-3 gap-3">
      <div class="bg-white shadow rounded-xl p-4 border-t-4 border-amber-400">
        <p class="text-sm text-gray-500">ğŸ¥‡ 1Âº</p>
        <p id="c5b-p1" class="font-bold">â€”</p>
        <p id="c5b-p1p" class="text-sm text-gray-700">â€” pts</p>
      </div>
      <div class="bg-white shadow rounded-xl p-4 border-t-4 border-gray-400">
        <p class="text-sm text-gray-500">ğŸ¥ˆ 2Âº</p>
        <p id="c5b-p2" class="font-bold">â€”</p>
        <p id="c5b-p2p" class="text-sm text-gray-700">â€” pts</p>
      </div>
      <div class="bg-white shadow rounded-xl p-4 border-t-4 border-orange-400">
        <p class="text-sm text-gray-500">ğŸ¥‰ 3Âº</p>
        <p id="c5b-p3" class="font-bold">â€”</p>
        <p id="c5b-p3p" class="text-sm text-gray-700">â€” pts</p>
      </div>
    </div>

    <!-- MVP de la semana -->
    <div class="bg-gradient-to-r from-teal-600 to-emerald-600 text-white rounded-xl p-4 shadow flex items-center justify-between">
      <div>
        <p class="text-sm opacity-90">Jugador/a de la semana</p>
        <p id="c5b-mvp-name" class="text-xl font-extrabold">AÃºn sin elegir</p>
      </div>
      <div class="text-right">
        <p id="c5b-mvp-points" class="text-sm opacity-90">â€” pts</p>
        <button id="c5b-btn-clear-mvp" class="mt-2 px-3 py-1 rounded bg-white/15 hover:bg-white/25">Quitar MVP</button>
      </div>
    </div>

    <!-- Registro rÃ¡pido de objetivos -->
    <div class="bg-white shadow rounded-xl p-4">
      <h4 class="font-semibold mb-3">Registrar objetivo rÃ¡pido</h4>
      <div class="flex flex-col md:flex-row gap-2 items-stretch md:items-center">
        <select id="c5b-quick-student" class="border rounded-lg px-3 py-2 flex-1"></select>
        <select id="c5b-quick-reason" class="border rounded-lg px-3 py-2">
          <option value="1">ğŸ“š Entrega de tareas (+1)</option>
          <option value="1">ğŸ™Œ Buena acciÃ³n (+1)</option>
          <option value="3">ğŸ“– Libro extra (+3)</option>
          <option value="-1">âŒ Falta de trabajo (-1)</option>
          <option value="-3">ğŸš« Incidencia grave (-3)</option>
        </select>
        <button id="c5b-quick-apply" class="btn-primary px-4 py-2 rounded-lg">Aplicar</button>
      </div>
    </div>

    <!-- Semana en curso (Lâ€“V) -->
    <div id="c5b-week" class="bg-white shadow rounded-xl p-4">
      <div class="flex items-center justify-between">
        <p class="font-semibold" id="c5a-period-title">Mes en curso</p>
        <p id="c5b-week-label" class="text-sm text-gray-500">0%</p>
      </div>
      <div class="h-3 bg-gray-100 rounded-full mt-2 overflow-hidden">
        <div id="c5b-week-bar" class="h-3 bg-gradient-to-r from-teal-500 to-emerald-500" style="width:0%"></div>
      </div>
      <div class="flex gap-1 mt-2" id="c5b-week-days">
        <span data-i="0" class="px-2 py-0.5 text-xs rounded bg-gray-100 text-gray-600">L</span>
        <span data-i="1" class="px-2 py-0.5 text-xs rounded bg-gray-100 text-gray-600">M</span>
        <span data-i="2" class="px-2 py-0.5 text-xs rounded bg-gray-100 text-gray-600">X</span>
        <span data-i="3" class="px-2 py-0.5 text-xs rounded bg-gray-100 text-gray-600">J</span>
        <span data-i="4" class="px-2 py-0.5 text-xs rounded bg-gray-100 text-gray-600">V</span>
      </div>
      <div id="c5b-reset-alert" class="hidden mt-3 px-3 py-2 rounded-lg bg-amber-50 text-amber-800 border border-amber-200 text-sm">
        Hace <span id="c5b-days-since">â€”</span> dÃ­as del Ãºltimo reinicio. Considera usar â€œReset puntosâ€.
      </div>
    </div>

    <!-- Leyenda de insignias (opcional) -->
    <div class="bg-white shadow rounded-xl p-4">
      <p class="text-sm font-semibold mb-2">Insignias disponibles</p>
      <div class="flex flex-wrap gap-2">
        <span class="badge-chip" data-type="constancia">â­ Constancia <span class="count">+1</span></span>
        <span class="badge-chip" data-type="companierismo">ğŸ¤ CompaÃ±erismo <span class="count">+1</span></span>
        <span class="badge-chip" data-type="lectura">ğŸ“– Lectura <span class="count">+1</span></span>
      </div>
    </div>

    <!-- Tabla de clasificaciÃ³n -->
    <div class="overflow-x-auto bg-white shadow rounded-xl">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-4 py-2 text-left text-xs font-medium uppercase">#</th>
            <th class="px-4 py-2 text-left text-xs font-medium uppercase">Alumno</th>
            <th class="px-4 py-2 text-left text-xs font-medium uppercase">Puntos</th>
            <th class="px-4 py-2 text-left text-xs font-medium uppercase">Insignias</th>
            <th class="px-4 py-2"></th>
          </tr>
        </thead>
        <tbody id="c5b-tbody" class="divide-y divide-gray-200"></tbody>
      </table>
    </div>

    <!-- Editor de lista -->
    <div id="c5b-editor" class="hidden bg-white shadow rounded-xl p-4">
      <h4 class="font-semibold mb-2">Editar lista de alumnos</h4>
      <p class="text-sm text-gray-600 mb-3">Escribe un nombre por lÃ­nea. <strong>Se reiniciarÃ¡n los puntos</strong> al aplicar cambios.</p>
      <textarea id="c5b-textarea" class="w-full h-40 border rounded-lg p-3 font-mono text-sm"></textarea>
      <div class="mt-3 flex gap-2">
        <button id="c5b-editor-apply" class="px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">Aplicar cambios</button>
        <button id="c5b-editor-cancel" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- LÃ³gica ESPECÃFICA de 5ÂºB (encapsulada) -->
 <script>
(function(){
  const sec = document.getElementById('5b');
  const KEY       = 'fantasy_5b_roster_v1';
  const KEY_MVP   = 'fantasy_5b_mvp_v1';
  const KEY_RESET = 'fantasy_5b_last_reset_v1';

  const defaultNames = [
    'AarÃ³n','Blanca','Carlos','Diana','Edgar','Fiona','GermÃ¡n','Helena','Ismael','Jana',
    'Kai','Laura','Miguel','Nadia','Omar','Patricia','Quim','RocÃ­o','SaÃºl','Tamara',
    'Ulises','Vanesa','Walter','Xiana','Yago'
  ];

  const $ = (sel)=>sec.querySelector(sel);

  /* Storage */
  function load(){ try{ const raw = localStorage.getItem(KEY); if(raw) return JSON.parse(raw);}catch(e){} return defaultNames.map(n=>({ name:n, points:0 })); }
  function save(){ localStorage.setItem(KEY, JSON.stringify(roster)); }
  function loadMvp(){ try{ const raw = localStorage.getItem(KEY_MVP); if(raw) return JSON.parse(raw);}catch(e){} return null; }
  function saveMvp(mvp){ if(mvp) localStorage.setItem(KEY_MVP, JSON.stringify(mvp)); else localStorage.removeItem(KEY_MVP); }

  /* Progreso semanal / reset */
  function getLastReset(){ const v = localStorage.getItem(KEY_RESET); return v? parseInt(v,10): null; }
  function setLastReset(ts){ localStorage.setItem(KEY_RESET, String(ts)); }
  function getWeekBounds(){
    const now = new Date();
    const d = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const mondayOffset = (d.getDay()+6)%7;
    const start = new Date(d); start.setDate(d.getDate()-mondayOffset); start.setHours(0,0,0,0);
    const end   = new Date(start); end.setDate(start.getDate()+4); end.setHours(23,59,59,999);
    return { now, start, end };
  }
function capitalize(str){ return str.charAt(0).toUpperCase() + str.slice(1); }

function renderProgress(){
  const bar     = $('#c5b-week-bar');
  const label   = $('#c5b-week-label');
  const titleEl = $('#c5b-period-title');
  const chips   = $('#c5b-week-days');
  const alert   = $('#c5b-reset-alert');
  const daysSpan= $('#c5b-days-since');

  const now = new Date();
  let start, end;

  if (now < new Date(2025, 10, 1)) {
    start = new Date(2025, 9, 1, 0,0,0,0);
    end   = new Date(2025,10, 0,23,59,59,999);
  } else {
    start = new Date(now.getFullYear(), now.getMonth(), 1, 0,0,0,0);
    end   = new Date(now.getFullYear(), now.getMonth()+1, 0,23,59,59,999);
  }

  const total = Math.max(1, end - start);
  let pct = 0;
  if (now <= start) pct = 0;
  else if (now >= end) pct = 1;
  else pct = (now - start) / total;

  if (bar)   bar.style.width = (pct*100).toFixed(0)+'%';
  if (label) label.textContent = (pct*100).toFixed(0)+'%';

  const mesTxt = start.toLocaleDateString('es-ES', { month:'long', year:'numeric' });
  if (titleEl) titleEl.textContent = `Mes en curso: ${capitalize(mesTxt)}`;

  if (chips) chips.classList.add('hidden');

  if(!alert) return;
  const last = getLastReset();
  if(last){
    const days = Math.floor((Date.now()-last)/(1000*60*60*24));
    if(daysSpan) daysSpan.textContent = String(days);
    alert.classList.toggle('hidden', days<7);
  }else{
    alert.classList.remove('hidden');
    alert.innerHTML = 'AÃºn no se ha reiniciado esta clase. Usa <strong>â€œReset puntosâ€</strong> al final de la semana.';
  }
}

  /* Insignias / Badges */
  function ensureBadges(){ roster.forEach(a=>{ if(!Array.isArray(a.badges)) a.badges = []; }); }
  const BADGE_TYPES = [
    { key:'constancia',    icon:'â­', label:'Constancia' },
    { key:'companierismo', icon:'ğŸ¤', label:'CompaÃ±erismo' },
    { key:'lectura',       icon:'ğŸ“–', label:'Lectura' },
  ];
  const BADGE_POINTS = { constancia:1, companierismo:1, lectura:1 };

  function groupBadges(arr){
    const map = { constancia:0, companierismo:0, lectura:0 };
    if(Array.isArray(arr)) arr.forEach(k=>{ if(map[k]!==undefined) map[k]++; });
    return map;
  }
  function badgesHTML(a){
    const map = groupBadges(a.badges || []);
    const parts = [];
    BADGE_TYPES.forEach(t=>{
      if(map[t.key]>0){
        parts.push(`<span class="badge-chip" data-type="${t.key}">${t.icon} ${t.label} <span class="count">x${map[t.key]}</span></span>`);
      }
    });
    return parts.join(' ');
  }
  function adjustPointsByBadgeMap(idx, map, sign = +1){
    Object.keys(map).forEach(k=>{
      const inc = (BADGE_POINTS[k] || 0) * (map[k] || 0) * sign;
      if(inc) roster[idx].points = Math.max(0, roster[idx].points + inc);
    });
  }

  function openBadgePicker(anchor, idx){
    const cell = anchor.closest('td'); if(!cell) return;
    closeBadgePicker();
    cell.classList.add('relative');
    const pop = document.createElement('div');
    pop.id = 'c5b-badge-pop';
    pop.className = 'absolute right-0 top-full mt-1 z-50 bg-white shadow-xl border border-gray-200 rounded-xl p-2 w-44';

    BADGE_TYPES.forEach(t=>{
      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'px-3 py-2 rounded hover:bg-gray-100 flex items-center gap-2 w-full text-sm';
      b.innerHTML = `<span>${t.icon}</span><span>${t.label}</span>`;
      b.addEventListener('click', (ev)=>{
        ev.stopPropagation();
        addBadge(idx, t.key);
        closeBadgePicker();
      });
      pop.appendChild(b);
    });

    const hr = document.createElement('div'); hr.className='my-1 border-t border-gray-200'; pop.appendChild(hr);
    const clear = document.createElement('button');
    clear.type='button';
    clear.className='px-3 py-2 rounded bg-amber-50 hover:bg-amber-100 text-amber-700 w-full text-sm';
    clear.textContent='ğŸ§¹ Quitar todas';
    clear.addEventListener('click', (ev)=>{
      ev.stopPropagation();
      const current = groupBadges(roster[idx].badges || []);
      adjustPointsByBadgeMap(idx, current, -1);
      roster[idx].badges = [];
      save(); renderAll(); closeBadgePicker();
    });
    pop.appendChild(clear);

    cell.appendChild(pop);
    const outside = (e)=>{ if(!pop.contains(e.target)){ document.removeEventListener('click', outside); closeBadgePicker(); } };
    setTimeout(()=> document.addEventListener('click', outside), 0);
  }
  function closeBadgePicker(){ const el = document.getElementById('c5b-badge-pop'); if(el) el.remove(); }
  function addBadge(idx, key){
    ensureBadges();
    roster[idx].badges.push(key);
    const inc = BADGE_POINTS[key] || 0;
    if(inc){ roster[idx].points = Math.max(0, roster[idx].points + inc); }
    save(); renderAll();
  }

  /* Estado */
  let roster = load();
  let mvp    = loadMvp();
  ensureBadges();

  /* Render */
  function sortRoster(){ roster.sort((a,b)=> b.points - a.points || a.name.localeCompare(b.name)); }
  function stats(){
    const count = roster.length;
    const total = roster.reduce((s,a)=>s+a.points,0);
    const avg = count? (total/count).toFixed(1) : '0.0';
    const leader = roster[0]? roster[0].name+' ('+roster[0].points+')':'â€”';
    $('#c5b-metric-count').textContent  = count;
    $('#c5b-metric-total').textContent  = total;
    $('#c5b-metric-avg').textContent    = avg;
    $('#c5b-metric-leader').textContent = leader;
  }
  function renderPodium(){
    const p1 = roster[0], p2 = roster[1], p3 = roster[2];
    $('#c5b-p1').textContent  = p1? p1.name : 'â€”';
    $('#c5b-p1p').textContent = p1? p1.points+' pts':'â€” pts';
    $('#c5b-p2').textContent  = p2? p2.name : 'â€”';
    $('#c5b-p2p').textContent = p2? p2.points+' pts':'â€” pts';
    $('#c5b-p3').textContent  = p3? p3.name : 'â€”';
    $('#c5b-p3p').textContent = p3? p3.points+' pts':'â€” pts';
  }
  function renderMvp(){
    if(mvp){ $('#c5b-mvp-name').textContent = mvp.name; $('#c5b-mvp-points').textContent = mvp.points+' pts'; }
    else { $('#c5b-mvp-name').textContent = 'AÃºn sin elegir'; $('#c5b-mvp-points').textContent = 'â€” pts'; }
  }
  function renderSelects(){
    const sel = $('#c5b-quick-student'); if(!sel) return;
    sel.innerHTML = '';
    roster.forEach((a,idx)=>{ const opt=document.createElement('option'); opt.value=idx; opt.textContent=a.name; sel.appendChild(opt); });
  }
  function renderTable(){
    const tbody = $('#c5b-tbody'); if(!tbody) return;
    tbody.innerHTML = '';
    roster.forEach((a,idx)=>{
      const tr = document.createElement('tr');
      tr.className = (mvp && mvp.name===a.name) ? 'bg-amber-50' : '';
      tr.innerHTML = `
        <td class="px-4 py-2 text-sm text-gray-700">${idx+1}</td>
        <td class="px-4 py-2 text-sm font-medium text-gray-900">${a.name}</td>
        <td class="px-4 py-2 text-sm text-gray-700">${a.points}</td>
        <td class="px-4 py-2 text-sm space-x-1">${badgesHTML(a) || '<span class="text-xs text-gray-400">â€”</span>'}</td>
        <td class="px-4 py-2 flex gap-1">
          <button class="btn-primary text-xs px-2 py-1 rounded" data-action="plus" data-index="${idx}">+1</button>
          <button class="bg-red-600 text-white text-xs px-2 py-1 rounded" data-action="minus" data-index="${idx}">-1</button>
          <button class="bg-amber-500 text-white text-xs px-2 py-1 rounded" data-action="star" data-index="${idx}">â­ MVP</button>
          <button class="bg-gray-800 text-white text-xs px-2 py-1 rounded" data-action="badge" data-index="${idx}">ğŸ…</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }
  function renderEditor(){ const ta = $('#c5b-textarea'); if(!ta) return; ta.value = roster.map(a=>a.name).join('\n'); }

  function renderAll(){ sortRoster(); stats(); renderPodium(); renderMvp(); renderSelects(); renderTable(); renderProgress(); }

  /* Eventos */
  $('#c5b-quick-apply')?.addEventListener('click', ()=>{
    const idx = parseInt($('#c5b-quick-student').value,10);
    const delta = parseInt($('#c5b-quick-reason').value,10);
    if(isNaN(idx)||isNaN(delta)) return;
    roster[idx].points = Math.max(0, roster[idx].points + delta);
    save(); renderAll();
  });

  $('#c5b-btn-mvp')?.addEventListener('click', ()=>{
    if(!roster.length) return;
    const idx = Math.floor(Math.random()*roster.length);
    mvp = { name: roster[idx].name, points: roster[idx].points }; saveMvp(mvp); renderAll();
  });

  $('#c5b-btn-clear-mvp')?.addEventListener('click', ()=>{ mvp=null; saveMvp(null); renderAll(); });

  $('#c5b-btn-reset')?.addEventListener('click', ()=>{
    if(confirm('Â¿Seguro que quieres poner a 0 todos los puntos de 5ÂºB?')){
      roster = roster.map(a=>({name:a.name, points:0, badges:[]}));
      mvp=null; save(); saveMvp(null); setLastReset(Date.now()); renderAll();
    }
  });

  $('#c5b-tbody')?.addEventListener('click', (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    const idx = parseInt(btn.getAttribute('data-index'),10);
    const action = btn.getAttribute('data-action'); if(Number.isNaN(idx)) return;

    if(action==='plus'){ roster[idx].points = Math.max(0, roster[idx].points + 1); }
    if(action==='minus'){
      roster[idx].points = Math.max(0, roster[idx].points - 1);
      const row = btn.closest('tr'); row?.classList.add('shake'); setTimeout(()=> row?.classList.remove('shake'), 220);
    }
    if(action==='star'){ mvp = { name: roster[idx].name, points: roster[idx].points }; saveMvp(mvp); }
    if(action==='badge'){ openBadgePicker(btn, idx); return; }

    save(); renderAll();
  });

  const editor = $('#c5b-editor');
  $('#c5b-btn-edit')?.addEventListener('click', ()=>{ editor.classList.toggle('hidden'); renderEditor(); });
  $('#c5b-editor-cancel')?.addEventListener('click', ()=> editor.classList.add('hidden'));
  $('#c5b-editor-apply')?.addEventListener('click', ()=>{
    const lines = $('#c5b-textarea').value.split('\n').map(s=>s.trim()).filter(Boolean);
    if(!lines.length) return;
    roster = lines.map(n=>({ name:n, points:0, badges:[] }));
    mvp=null; save(); saveMvp(null); editor.classList.add('hidden'); renderAll();
  });

  const obs = new MutationObserver(()=>{ if(!sec.classList.contains('hidden')) renderAll(); });
  obs.observe(sec, { attributes:true });
  if(!sec.classList.contains('hidden')) renderAll();
})();
</script>
</section>
      <section id="6a" class="hidden">
  <!-- 6ÂºA: Panel de clase (aislado) -->
  <div class="flex flex-col gap-4">
    <!-- Encabezado + Acciones -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div>
        <h3 class="text-3xl font-extrabold tracking-tight">Clase 6ÂºA</h3>
        <p class="text-sm text-gray-600">Temporada 25/26 Â· GestiÃ³n local (solo en este dispositivo)</p>
      </div>
      <div class="flex flex-wrap gap-2">
        <button id="c6a-btn-mvp" class="px-4 py-2 rounded-lg bg-violet-600 text-white hover:bg-violet-700 shadow">ğŸ² Sorteo MVP</button>
        <button id="c6a-btn-reset" class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 shadow">ğŸ§¹ Reset puntos</button>
        <button id="c6a-btn-edit" class="px-4 py-2 rounded-lg bg-gray-900 text-white hover:bg-black shadow">âœï¸ Editar lista</button>
      </div>
    </div>

    <!-- Tarjetas de mÃ©tricas -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
      <div class="bg-white shadow rounded-xl p-4">
        <p class="text-xs text-gray-500">Alumnos</p>
        <p id="c6a-metric-count" class="text-2xl font-bold">â€”</p>
      </div>
      <div class="bg-white shadow rounded-xl p-4">
        <p class="text-xs text-gray-500">Puntos totales</p>
        <p id="c6a-metric-total" class="text-2xl font-bold">â€”</p>
      </div>
      <div class="bg-white shadow rounded-xl p-4">
        <p class="text-xs text-gray-500">Media</p>
        <p id="c6a-metric-avg" class="text-2xl font-bold">â€”</p>
      </div>
      <div class="bg-white shadow rounded-xl p-4">
        <p class="text-xs text-gray-500">LÃ­der</p>
        <p id="c6a-metric-leader" class="text-sm font-semibold">â€”</p>
      </div>
    </div>

    <!-- Podio -->
    <div class="grid md:grid-cols-3 gap-3">
      <div class="bg-white shadow rounded-xl p-4 border-t-4 border-amber-400">
        <p class="text-sm text-gray-500">ğŸ¥‡ 1Âº</p>
        <p id="c6a-p1" class="font-bold">â€”</p>
        <p id="c6a-p1p" class="text-sm text-gray-700">â€” pts</p>
      </div>
      <div class="bg-white shadow rounded-xl p-4 border-t-4 border-gray-400">
        <p class="text-sm text-gray-500">ğŸ¥ˆ 2Âº</p>
        <p id="c6a-p2" class="font-bold">â€”</p>
        <p id="c6a-p2p" class="text-sm text-gray-700">â€” pts</p>
      </div>
      <div class="bg-white shadow rounded-xl p-4 border-t-4 border-orange-400">
        <p class="text-sm text-gray-500">ğŸ¥‰ 3Âº</p>
        <p id="c6a-p3" class="font-bold">â€”</p>
        <p id="c6a-p3p" class="text-sm text-gray-700">â€” pts</p>
      </div>
    </div>

    <!-- MVP de la semana -->
    <div class="bg-gradient-to-r from-violet-600 to-fuchsia-600 text-white rounded-xl p-4 shadow flex items-center justify-between">
      <div>
        <p class="text-sm opacity-90">Jugador/a de la semana</p>
        <p id="c6a-mvp-name" class="text-xl font-extrabold">AÃºn sin elegir</p>
      </div>
      <div class="text-right">
        <p id="c6a-mvp-points" class="text-sm opacity-90">â€” pts</p>
        <button id="c6a-btn-clear-mvp" class="mt-2 px-3 py-1 rounded bg-white/15 hover:bg-white/25">Quitar MVP</button>
      </div>
    </div>

    <!-- Registro rÃ¡pido de objetivos -->
    <div class="bg-white shadow rounded-xl p-4">
      <h4 class="font-semibold mb-3">Registrar objetivo rÃ¡pido</h4>
      <div class="flex flex-col md:flex-row gap-2 items-stretch md:items-center">
        <select id="c6a-quick-student" class="border rounded-lg px-3 py-2 flex-1"></select>
        <select id="c6a-quick-reason" class="border rounded-lg px-3 py-2">
          <option value="1">ğŸ“š Entrega de tareas (+1)</option>
          <option value="1">ğŸ™Œ Buena acciÃ³n (+1)</option>
          <option value="3">ğŸ“– Libro extra (+3)</option>
          <option value="-1">âŒ Falta de trabajo (-1)</option>
          <option value="-3">ğŸš« Incidencia grave (-3)</option>
        </select>
        <button id="c6a-quick-apply" class="btn-primary px-4 py-2 rounded-lg">Aplicar</button>
      </div>
    </div>

    <!-- Semana en curso (Lâ€“V) -->
    <div id="c6a-week" class="bg-white shadow rounded-xl p-4">
      <div class="flex items-center justify-between">
        <p class="font-semibold" id="c6a-period-title">Mes en curso</p>
        <p id="c6a-week-label" class="text-sm text-gray-500">0%</p>
      </div>
      <div class="h-3 bg-gray-100 rounded-full mt-2 overflow-hidden">
        <div id="c6a-week-bar" class="h-3 bg-gradient-to-r from-violet-500 to-fuchsia-500" style="width:0%"></div>
      </div>
      <div class="flex gap-1 mt-2" id="c6a-week-days">
        <span data-i="0" class="px-2 py-0.5 text-xs rounded bg-gray-100 text-gray-600">L</span>
        <span data-i="1" class="px-2 py-0.5 text-xs rounded bg-gray-100 text-gray-600">M</span>
        <span data-i="2" class="px-2 py-0.5 text-xs rounded bg-gray-100 text-gray-600">X</span>
        <span data-i="3" class="px-2 py-0.5 text-xs rounded bg-gray-100 text-gray-600">J</span>
        <span data-i="4" class="px-2 py-0.5 text-xs rounded bg-gray-100 text-gray-600">V</span>
      </div>
      <div id="c6a-reset-alert" class="hidden mt-3 px-3 py-2 rounded-lg bg-amber-50 text-amber-800 border border-amber-200 text-sm">
        Hace <span id="c6a-days-since">â€”</span> dÃ­as del Ãºltimo reinicio. Considera usar â€œReset puntosâ€.
      </div>
    </div>

    <!-- Leyenda de insignias (opcional) -->
    <div class="bg-white shadow rounded-xl p-4">
      <p class="text-sm font-semibold mb-2">Insignias disponibles</p>
      <div class="flex flex-wrap gap-2">
        <span class="badge-chip" data-type="constancia">â­ Constancia <span class="count">+1</span></span>
        <span class="badge-chip" data-type="companierismo">ğŸ¤ CompaÃ±erismo <span class="count">+1</span></span>
        <span class="badge-chip" data-type="lectura">ğŸ“– Lectura <span class="count">+1</span></span>
      </div>
    </div>

    <!-- Tabla de clasificaciÃ³n -->
    <div class="overflow-x-auto bg-white shadow rounded-xl">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-4 py-2 text-left text-xs font-medium uppercase">#</th>
            <th class="px-4 py-2 text-left text-xs font-medium uppercase">Alumno</th>
            <th class="px-4 py-2 text-left text-xs font-medium uppercase">Puntos</th>
            <th class="px-4 py-2 text-left text-xs font-medium uppercase">Insignias</th>
            <th class="px-4 py-2"></th>
          </tr>
        </thead>
        <tbody id="c6a-tbody" class="divide-y divide-gray-200"></tbody>
      </table>
    </div>

    <!-- Editor de lista -->
    <div id="c6a-editor" class="hidden bg-white shadow rounded-xl p-4">
      <h4 class="font-semibold mb-2">Editar lista de alumnos</h4>
      <p class="text-sm text-gray-600 mb-3">Escribe un nombre por lÃ­nea. <strong>Se reiniciarÃ¡n los puntos</strong> al aplicar cambios.</p>
      <textarea id="c6a-textarea" class="w-full h-40 border rounded-lg p-3 font-mono text-sm"></textarea>
      <div class="mt-3 flex gap-2">
        <button id="c6a-editor-apply" class="px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">Aplicar cambios</button>
        <button id="c6a-editor-cancel" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- LÃ³gica ESPECÃFICA de 6ÂºA (encapsulada) -->
  <script>
(function(){
  const sec = document.getElementById('6a');
  const KEY       = 'fantasy_6a_roster_v1';
  const KEY_MVP   = 'fantasy_6a_mvp_v1';
  const KEY_RESET = 'fantasy_6a_last_reset_v1';

  const defaultNames = [
    'AndrÃ©s','Camila','Guille','Marta','Ã“scar','Teresa','Iker','Ariadna','RaÃºl','Nerea',
    'Gael','Luna','Santiago','Clara','Thiago','Iris','Rodrigo','Elisa','NicolÃ¡s','Ainhoa',
    'Jorge','Vera','SofÃ­a M.','IvÃ¡n R.','LucÃ­a G.'
  ];

  const $ = (sel)=>sec.querySelector(sel);

  /* Storage */
  function load(){ try{ const raw = localStorage.getItem(KEY); if(raw) return JSON.parse(raw);}catch(e){} return defaultNames.map(n=>({ name:n, points:0 })); }
  function save(){ localStorage.setItem(KEY, JSON.stringify(roster)); }
  function loadMvp(){ try{ const raw = localStorage.getItem(KEY_MVP); if(raw) return JSON.parse(raw);}catch(e){} return null; }
  function saveMvp(mvp){ if(mvp) localStorage.setItem(KEY_MVP, JSON.stringify(mvp)); else localStorage.removeItem(KEY_MVP); }

  /* Progreso semanal / reset */
  function getLastReset(){ const v = localStorage.getItem(KEY_RESET); return v? parseInt(v,10): null; }
  function setLastReset(ts){ localStorage.setItem(KEY_RESET, String(ts)); }
  function getWeekBounds(){
    const now = new Date();
    const d = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const mondayOffset = (d.getDay()+6)%7;
    const start = new Date(d); start.setDate(d.getDate()-mondayOffset); start.setHours(0,0,0,0);
    const end   = new Date(start); end.setDate(start.getDate()+4); end.setHours(23,59,59,999);
    return { now, start, end };
  }
  function capitalize(str){ return str.charAt(0).toUpperCase() + str.slice(1); }
function renderProgress(){
  const bar     = $('#c6a-week-bar');
  const label   = $('#c6a-week-label');
  const titleEl = $('#c6a-period-title');
  const chips   = $('#c6a-week-days');
  const alert   = $('#c6a-reset-alert');
  const daysSpan= $('#c6a-days-since');

  const now = new Date();
  let start, end;

  if (now < new Date(2025, 10, 1)) {
    start = new Date(2025, 9, 1, 0,0,0,0);
    end   = new Date(2025,10, 0,23,59,59,999);
  } else {
    start = new Date(now.getFullYear(), now.getMonth(), 1, 0,0,0,0);
    end   = new Date(now.getFullYear(), now.getMonth()+1, 0,23,59,59,999);
  }

  const total = Math.max(1, end - start);
  let pct = 0;
  if (now <= start) pct = 0;
  else if (now >= end) pct = 1;
  else pct = (now - start) / total;

  if (bar)   bar.style.width = (pct*100).toFixed(0)+'%';
  if (label) label.textContent = (pct*100).toFixed(0)+'%';

  const mesTxt = start.toLocaleDateString('es-ES', { month:'long', year:'numeric' });
  if (titleEl) titleEl.textContent = `Mes en curso: ${capitalize(mesTxt)}`;

  if (chips) chips.classList.add('hidden');

  if(!alert) return;
  const last = getLastReset();
  if(last){
    const days = Math.floor((Date.now()-last)/(1000*60*60*24));
    if(daysSpan) daysSpan.textContent = String(days);
    alert.classList.toggle('hidden', days<7);
  }else{
    alert.classList.remove('hidden');
    alert.innerHTML = 'AÃºn no se ha reiniciado esta clase. Usa <strong>â€œReset puntosâ€</strong> al final de la semana.';
  }
}

  /* Insignias / Badges */
  function ensureBadges(){ roster.forEach(a=>{ if(!Array.isArray(a.badges)) a.badges = []; }); }
  const BADGE_TYPES = [
    { key:'constancia',    icon:'â­', label:'Constancia' },
    { key:'companierismo', icon:'ğŸ¤', label:'CompaÃ±erismo' },
    { key:'lectura',       icon:'ğŸ“–', label:'Lectura' },
  ];
  const BADGE_POINTS = { constancia:1, companierismo:1, lectura:1 };

  function groupBadges(arr){
    const map = { constancia:0, companierismo:0, lectura:0 };
    if(Array.isArray(arr)) arr.forEach(k=>{ if(map[k]!==undefined) map[k]++; });
    return map;
  }
  function badgesHTML(a){
    const map = groupBadges(a.badges || []);
    const parts = [];
    BADGE_TYPES.forEach(t=>{
      if(map[t.key]>0){
        parts.push(`<span class="badge-chip" data-type="${t.key}">${t.icon} ${t.label} <span class="count">x${map[t.key]}</span></span>`);
      }
    });
    return parts.join(' ');
  }
  function adjustPointsByBadgeMap(idx, map, sign = +1){
    Object.keys(map).forEach(k=>{
      const inc = (BADGE_POINTS[k] || 0) * (map[k] || 0) * sign;
      if(inc) roster[idx].points = Math.max(0, roster[idx].points + inc);
    });
  }

  function openBadgePicker(anchor, idx){
    const cell = anchor.closest('td'); if(!cell) return;
    closeBadgePicker();
    cell.classList.add('relative');
    const pop = document.createElement('div');
    pop.id = 'c6a-badge-pop';
    pop.className = 'absolute right-0 top-full mt-1 z-50 bg-white shadow-xl border border-gray-200 rounded-xl p-2 w-44';

    BADGE_TYPES.forEach(t=>{
      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'px-3 py-2 rounded hover:bg-gray-100 flex items-center gap-2 w-full text-sm';
      b.innerHTML = `<span>${t.icon}</span><span>${t.label}</span>`;
      b.addEventListener('click', (ev)=>{
        ev.stopPropagation();
        addBadge(idx, t.key);
        closeBadgePicker();
      });
      pop.appendChild(b);
    });

    const hr = document.createElement('div'); hr.className='my-1 border-t border-gray-200'; pop.appendChild(hr);
    const clear = document.createElement('button');
    clear.type='button';
    clear.className='px-3 py-2 rounded bg-amber-50 hover:bg-amber-100 text-amber-700 w-full text-sm';
    clear.textContent='ğŸ§¹ Quitar todas';
    clear.addEventListener('click', (ev)=>{
      ev.stopPropagation();
      const current = groupBadges(roster[idx].badges || []);
      adjustPointsByBadgeMap(idx, current, -1);
      roster[idx].badges = [];
      save(); renderAll(); closeBadgePicker();
    });
    pop.appendChild(clear);

    cell.appendChild(pop);
    const outside = (e)=>{ if(!pop.contains(e.target)){ document.removeEventListener('click', outside); closeBadgePicker(); } };
    setTimeout(()=> document.addEventListener('click', outside), 0);
  }
  function closeBadgePicker(){ const el = document.getElementById('c6a-badge-pop'); if(el) el.remove(); }
  function addBadge(idx, key){
    ensureBadges();
    roster[idx].badges.push(key);
    const inc = BADGE_POINTS[key] || 0;
    if(inc){ roster[idx].points = Math.max(0, roster[idx].points + inc); }
    save(); renderAll();
  }

  /* Estado */
  let roster = load();
  let mvp    = loadMvp();
  ensureBadges();

  /* Render */
  function sortRoster(){ roster.sort((a,b)=> b.points - a.points || a.name.localeCompare(b.name)); }
  function stats(){
    const count = roster.length;
    const total = roster.reduce((s,a)=>s+a.points,0);
    const avg = count? (total/count).toFixed(1) : '0.0';
    const leader = roster[0]? roster[0].name+' ('+roster[0].points+')':'â€”';
    $('#c6a-metric-count').textContent  = count;
    $('#c6a-metric-total').textContent  = total;
    $('#c6a-metric-avg').textContent    = avg;
    $('#c6a-metric-leader').textContent = leader;
  }
  function renderPodium(){
    const p1 = roster[0], p2 = roster[1], p3 = roster[2];
    $('#c6a-p1').textContent  = p1? p1.name : 'â€”';
    $('#c6a-p1p').textContent = p1? p1.points+' pts':'â€” pts';
    $('#c6a-p2').textContent  = p2? p2.name : 'â€”';
    $('#c6a-p2p').textContent = p2? p2.points+' pts':'â€” pts';
    $('#c6a-p3').textContent  = p3? p3.name : 'â€”';
    $('#c6a-p3p').textContent = p3? p3.points+' pts':'â€” pts';
  }
  function renderMvp(){
    if(mvp){ $('#c6a-mvp-name').textContent = mvp.name; $('#c6a-mvp-points').textContent = mvp.points+' pts'; }
    else { $('#c6a-mvp-name').textContent = 'AÃºn sin elegir'; $('#c6a-mvp-points').textContent = 'â€” pts'; }
  }
  function renderSelects(){
    const sel = $('#c6a-quick-student'); if(!sel) return;
    sel.innerHTML = '';
    roster.forEach((a,idx)=>{ const opt=document.createElement('option'); opt.value=idx; opt.textContent=a.name; sel.appendChild(opt); });
  }
  function renderTable(){
    const tbody = $('#c6a-tbody'); if(!tbody) return;
    tbody.innerHTML = '';
    roster.forEach((a,idx)=>{
      const tr = document.createElement('tr');
      tr.className = (mvp && mvp.name===a.name) ? 'bg-amber-50' : '';
      tr.innerHTML = `
        <td class="px-4 py-2 text-sm text-gray-700">${idx+1}</td>
        <td class="px-4 py-2 text-sm font-medium text-gray-900">${a.name}</td>
        <td class="px-4 py-2 text-sm text-gray-700">${a.points}</td>
        <td class="px-4 py-2 text-sm space-x-1">${badgesHTML(a) || '<span class="text-xs text-gray-400">â€”</span>'}</td>
        <td class="px-4 py-2 flex gap-1">
          <button class="btn-primary text-xs px-2 py-1 rounded" data-action="plus" data-index="${idx}">+1</button>
          <button class="bg-red-600 text-white text-xs px-2 py-1 rounded" data-action="minus" data-index="${idx}">-1</button>
          <button class="bg-amber-500 text-white text-xs px-2 py-1 rounded" data-action="star" data-index="${idx}">â­ MVP</button>
          <button class="bg-gray-800 text-white text-xs px-2 py-1 rounded" data-action="badge" data-index="${idx}">ğŸ…</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }
  function renderEditor(){ const ta = $('#c6a-textarea'); if(!ta) return; ta.value = roster.map(a=>a.name).join('\n'); }

  function renderAll(){ sortRoster(); stats(); renderPodium(); renderMvp(); renderSelects(); renderTable(); renderProgress(); }

  /* Eventos */
  $('#c6a-quick-apply')?.addEventListener('click', ()=>{
    const idx = parseInt($('#c6a-quick-student').value,10);
    const delta = parseInt($('#c6a-quick-reason').value,10);
    if(isNaN(idx)||isNaN(delta)) return;
    roster[idx].points = Math.max(0, roster[idx].points + delta);
    save(); renderAll();
  });

  $('#c6a-btn-mvp')?.addEventListener('click', ()=>{
    if(!roster.length) return;
    const idx = Math.floor(Math.random()*roster.length);
    mvp = { name: roster[idx].name, points: roster[idx].points }; saveMvp(mvp); renderAll();
  });

  $('#c6a-btn-clear-mvp')?.addEventListener('click', ()=>{ mvp=null; saveMvp(null); renderAll(); });

  $('#c6a-btn-reset')?.addEventListener('click', ()=>{
    if(confirm('Â¿Seguro que quieres poner a 0 todos los puntos de 6ÂºA?')){
      roster = roster.map(a=>({name:a.name, points:0, badges:[]}));
      mvp=null; save(); saveMvp(null); setLastReset(Date.now()); renderAll();
    }
  });

  $('#c6a-tbody')?.addEventListener('click', (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    const idx = parseInt(btn.getAttribute('data-index'),10);
    const action = btn.getAttribute('data-action'); if(Number.isNaN(idx)) return;

    if(action==='plus'){ roster[idx].points = Math.max(0, roster[idx].points + 1); }
    if(action==='minus'){
      roster[idx].points = Math.max(0, roster[idx].points - 1);
      const row = btn.closest('tr'); row?.classList.add('shake'); setTimeout(()=> row?.classList.remove('shake'), 220);
    }
    if(action==='star'){ mvp = { name: roster[idx].name, points: roster[idx].points }; saveMvp(mvp); }
    if(action==='badge'){ openBadgePicker(btn, idx); return; }

    save(); renderAll();
  });

  const editor = $('#c6a-editor');
  $('#c6a-btn-edit')?.addEventListener('click', ()=>{ editor.classList.toggle('hidden'); renderEditor(); });
  $('#c6a-editor-cancel')?.addEventListener('click', ()=> editor.classList.add('hidden'));
  $('#c6a-editor-apply')?.addEventListener('click', ()=>{
    const lines = $('#c6a-textarea').value.split('\n').map(s=>s.trim()).filter(Boolean);
    if(!lines.length) return;
    roster = lines.map(n=>({ name:n, points:0, badges:[] }));
    mvp=null; save(); saveMvp(null); editor.classList.add('hidden'); renderAll();
  });

  const obs = new MutationObserver(()=>{ if(!sec.classList.contains('hidden')) renderAll(); });
  obs.observe(sec, { attributes:true });
  if(!sec.classList.contains('hidden')) renderAll();
})();
</script>
</section>
     <section id="6b" class="hidden">
  <!-- 6ÂºB: Panel de clase (aislado) -->
  <div class="flex flex-col gap-4">
    <!-- Encabezado + Acciones -->
    <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-3">
      <div>
        <h3 class="text-3xl font-extrabold tracking-tight">Clase 6ÂºB</h3>
        <p class="text-sm text-gray-600">Temporada 25/26 Â· GestiÃ³n local (solo en este dispositivo)</p>
      </div>
      <div class="flex flex-wrap gap-2">
        <button id="c6b-btn-mvp" class="px-4 py-2 rounded-lg bg-sky-600 text-white hover:bg-sky-700 shadow">ğŸ² Sorteo MVP</button>
        <button id="c6b-btn-reset" class="px-4 py-2 rounded-lg bg-red-600 text-white hover:bg-red-700 shadow">ğŸ§¹ Reset puntos</button>
        <button id="c6b-btn-edit" class="px-4 py-2 rounded-lg bg-gray-900 text-white hover:bg-black shadow">âœï¸ Editar lista</button>
      </div>
    </div>

    <!-- Tarjetas de mÃ©tricas -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-3">
      <div class="bg-white shadow rounded-xl p-4">
        <p class="text-xs text-gray-500">Alumnos</p>
        <p id="c6b-metric-count" class="text-2xl font-bold">â€”</p>
      </div>
      <div class="bg-white shadow rounded-xl p-4">
        <p class="text-xs text-gray-500">Puntos totales</p>
        <p id="c6b-metric-total" class="text-2xl font-bold">â€”</p>
      </div>
      <div class="bg-white shadow rounded-xl p-4">
        <p class="text-xs text-gray-500">Media</p>
        <p id="c6b-metric-avg" class="text-2xl font-bold">â€”</p>
      </div>
      <div class="bg-white shadow rounded-xl p-4">
        <p class="text-xs text-gray-500">LÃ­der</p>
        <p id="c6b-metric-leader" class="text-sm font-semibold">â€”</p>
      </div>
    </div>

    <!-- Podio -->
    <div class="grid md:grid-cols-3 gap-3">
      <div class="bg-white shadow rounded-xl p-4 border-t-4 border-amber-400">
        <p class="text-sm text-gray-500">ğŸ¥‡ 1Âº</p>
        <p id="c6b-p1" class="font-bold">â€”</p>
        <p id="c6b-p1p" class="text-sm text-gray-700">â€” pts</p>
      </div>
      <div class="bg-white shadow rounded-xl p-4 border-t-4 border-gray-400">
        <p class="text-sm text-gray-500">ğŸ¥ˆ 2Âº</p>
        <p id="c6b-p2" class="font-bold">â€”</p>
        <p id="c6b-p2p" class="text-sm text-gray-700">â€” pts</p>
      </div>
      <div class="bg-white shadow rounded-xl p-4 border-t-4 border-orange-400">
        <p class="text-sm text-gray-500">ğŸ¥‰ 3Âº</p>
        <p id="c6b-p3" class="font-bold">â€”</p>
        <p id="c6b-p3p" class="text-sm text-gray-700">â€” pts</p>
      </div>
    </div>

    <!-- MVP de la semana -->
    <div class="bg-gradient-to-r from-sky-600 to-blue-600 text-white rounded-xl p-4 shadow flex items-center justify-between">
      <div>
        <p class="text-sm opacity-90">Jugador/a de la semana</p>
        <p id="c6b-mvp-name" class="text-xl font-extrabold">AÃºn sin elegir</p>
      </div>
      <div class="text-right">
        <p id="c6b-mvp-points" class="text-sm opacity-90">â€” pts</p>
        <button id="c6b-btn-clear-mvp" class="mt-2 px-3 py-1 rounded bg-white/15 hover:bg-white/25">Quitar MVP</button>
      </div>
    </div>

    <!-- Registro rÃ¡pido de objetivos -->
    <div class="bg-white shadow rounded-xl p-4">
      <h4 class="font-semibold mb-3">Registrar objetivo rÃ¡pido</h4>
      <div class="flex flex-col md:flex-row gap-2 items-stretch md:items-center">
        <select id="c6b-quick-student" class="border rounded-lg px-3 py-2 flex-1"></select>
        <select id="c6b-quick-reason" class="border rounded-lg px-3 py-2">
          <option value="1">ğŸ“š Entrega de tareas (+1)</option>
          <option value="1">ğŸ™Œ Buena acciÃ³n (+1)</option>
          <option value="3">ğŸ“– Libro extra (+3)</option>
          <option value="-1">âŒ Falta de trabajo (-1)</option>
          <option value="-3">ğŸš« Incidencia grave (-3)</option>
        </select>
        <button id="c6b-quick-apply" class="btn-primary px-4 py-2 rounded-lg">Aplicar</button>
      </div>
    </div>

    <!-- Semana en curso (Lâ€“V) -->
    <div id="c6b-week" class="bg-white shadow rounded-xl p-4">
      <div class="flex items-center justify-between">
       <p class="font-semibold" id="c6b-period-title">Mes en curso</p>
        <p id="c6b-week-label" class="text-sm text-gray-500">0%</p>
      </div>
      <div class="h-3 bg-gray-100 rounded-full mt-2 overflow-hidden">
        <div id="c6b-week-bar" class="h-3 bg-gradient-to-r from-sky-500 to-blue-500" style="width:0%"></div>
      </div>
      <div class="flex gap-1 mt-2" id="c6b-week-days">
        <span data-i="0" class="px-2 py-0.5 text-xs rounded bg-gray-100 text-gray-600">L</span>
        <span data-i="1" class="px-2 py-0.5 text-xs rounded bg-gray-100 text-gray-600">M</span>
        <span data-i="2" class="px-2 py-0.5 text-xs rounded bg-gray-100 text-gray-600">X</span>
        <span data-i="3" class="px-2 py-0.5 text-xs rounded bg-gray-100 text-gray-600">J</span>
        <span data-i="4" class="px-2 py-0.5 text-xs rounded bg-gray-100 text-gray-600">V</span>
      </div>
      <div id="c6b-reset-alert" class="hidden mt-3 px-3 py-2 rounded-lg bg-amber-50 text-amber-800 border border-amber-200 text-sm">
        Hace <span id="c6b-days-since">â€”</span> dÃ­as del Ãºltimo reinicio. Considera usar â€œReset puntosâ€.
      </div>
    </div>

    <!-- Leyenda de insignias (opcional) -->
    <div class="bg-white shadow rounded-xl p-4">
      <p class="text-sm font-semibold mb-2">Insignias disponibles</p>
      <div class="flex flex-wrap gap-2">
        <span class="badge-chip" data-type="constancia">â­ Constancia <span class="count">+1</span></span>
        <span class="badge-chip" data-type="companierismo">ğŸ¤ CompaÃ±erismo <span class="count">+1</span></span>
        <span class="badge-chip" data-type="lectura">ğŸ“– Lectura <span class="count">+1</span></span>
      </div>
    </div>

    <!-- Tabla de clasificaciÃ³n -->
    <div class="overflow-x-auto bg-white shadow rounded-xl">
      <table class="min-w-full divide-y divide-gray-200">
        <thead class="bg-gray-50">
          <tr>
            <th class="px-4 py-2 text-left text-xs font-medium uppercase">#</th>
            <th class="px-4 py-2 text-left text-xs font-medium uppercase">Alumno</th>
            <th class="px-4 py-2 text-left text-xs font-medium uppercase">Puntos</th>
            <th class="px-4 py-2 text-left text-xs font-medium uppercase">Insignias</th>
            <th class="px-4 py-2"></th>
          </tr>
        </thead>
        <tbody id="c6b-tbody" class="divide-y divide-gray-200"></tbody>
      </table>
    </div>

    <!-- Editor de lista -->
    <div id="c6b-editor" class="hidden bg-white shadow rounded-xl p-4">
      <h4 class="font-semibold mb-2">Editar lista de alumnos</h4>
      <p class="text-sm text-gray-600 mb-3">Escribe un nombre por lÃ­nea. <strong>Se reiniciarÃ¡n los puntos</strong> al aplicar cambios.</p>
      <textarea id="c6b-textarea" class="w-full h-40 border rounded-lg p-3 font-mono text-sm"></textarea>
      <div class="mt-3 flex gap-2">
        <button id="c6b-editor-apply" class="px-4 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">Aplicar cambios</button>
        <button id="c6b-editor-cancel" class="px-4 py-2 rounded-lg bg-gray-200 hover:bg-gray-300">Cancelar</button>
      </div>
    </div>
  </div>

  <!-- LÃ³gica ESPECÃFICA de 6ÂºB (encapsulada) -->
 <script>
(function(){
  const sec = document.getElementById('6b');
  const KEY       = 'fantasy_6b_roster_v1';
  const KEY_MVP   = 'fantasy_6b_mvp_v1';
  const KEY_RESET = 'fantasy_6b_last_reset_v1';

  const defaultNames = [
    'AarÃ³n','Blanca','Carlos','Diana','Edgar','Fiona','GermÃ¡n','Helena','Ismael','Jana',
    'Kai','Laura','Miguel','Nadia','Omar','Patricia','Quim','RocÃ­o','SaÃºl','Tamara',
    'Ulises','Vanesa','Walter','Xiana','Yago'
  ];

  const $ = (sel)=>sec.querySelector(sel);

  /* Storage */
  function load(){ try{ const raw = localStorage.getItem(KEY); if(raw) return JSON.parse(raw);}catch(e){} return defaultNames.map(n=>({ name:n, points:0 })); }
  function save(){ localStorage.setItem(KEY, JSON.stringify(roster)); }
  function loadMvp(){ try{ const raw = localStorage.getItem(KEY_MVP); if(raw) return JSON.parse(raw);}catch(e){} return null; }
  function saveMvp(mvp){ if(mvp) localStorage.setItem(KEY_MVP, JSON.stringify(mvp)); else localStorage.removeItem(KEY_MVP); }

  /* Progreso semanal / reset */
  function getLastReset(){ const v = localStorage.getItem(KEY_RESET); return v? parseInt(v,10): null; }
  function setLastReset(ts){ localStorage.setItem(KEY_RESET, String(ts)); }
  function getWeekBounds(){
    const now = new Date();
    const d = new Date(now.getFullYear(), now.getMonth(), now.getDate());
    const mondayOffset = (d.getDay()+6)%7;
    const start = new Date(d); start.setDate(d.getDate()-mondayOffset); start.setHours(0,0,0,0);
    const end   = new Date(start); end.setDate(start.getDate()+4); end.setHours(23,59,59,999);
    return { now, start, end };
  }
  function capitalize(str){ return str.charAt(0).toUpperCase() + str.slice(1); }

function renderProgress(){
  const bar     = $('#c6b-week-bar');
  const label   = $('#c6b-week-label');
  const titleEl = $('#c6b-period-title');
  const chips   = $('#c6b-week-days');
  const alert   = $('#c6b-reset-alert');
  const daysSpan= $('#c6b-days-since');

  const now = new Date();
  let start, end;

  if (now < new Date(2025, 10, 1)) {
    start = new Date(2025, 9, 1, 0,0,0,0);
    end   = new Date(2025,10, 0,23,59,59,999);
  } else {
    start = new Date(now.getFullYear(), now.getMonth(), 1, 0,0,0,0);
    end   = new Date(now.getFullYear(), now.getMonth()+1, 0,23,59,59,999);
  }

  const total = Math.max(1, end - start);
  let pct = 0;
  if (now <= start) pct = 0;
  else if (now >= end) pct = 1;
  else pct = (now - start) / total;

  if (bar)   bar.style.width = (pct*100).toFixed(0)+'%';
  if (label) label.textContent = (pct*100).toFixed(0)+'%';

  const mesTxt = start.toLocaleDateString('es-ES', { month:'long', year:'numeric' });
  if (titleEl) titleEl.textContent = `Mes en curso: ${capitalize(mesTxt)}`;

  if (chips) chips.classList.add('hidden');

  if(!alert) return;
  const last = getLastReset();
  if(last){
    const days = Math.floor((Date.now()-last)/(1000*60*60*24));
    if(daysSpan) daysSpan.textContent = String(days);
    alert.classList.toggle('hidden', days<7);
  }else{
    alert.classList.remove('hidden');
    alert.innerHTML = 'AÃºn no se ha reiniciado esta clase. Usa <strong>â€œReset puntosâ€</strong> al final de la semana.';
  }
}
  /* Insignias / Badges */
  function ensureBadges(){ roster.forEach(a=>{ if(!Array.isArray(a.badges)) a.badges = []; }); }
  const BADGE_TYPES = [
    { key:'constancia',    icon:'â­', label:'Constancia' },
    { key:'companierismo', icon:'ğŸ¤', label:'CompaÃ±erismo' },
    { key:'lectura',       icon:'ğŸ“–', label:'Lectura' },
  ];
  const BADGE_POINTS = { constancia:1, companierismo:1, lectura:1 };

  function groupBadges(arr){
    const map = { constancia:0, companierismo:0, lectura:0 };
    if(Array.isArray(arr)) arr.forEach(k=>{ if(map[k]!==undefined) map[k]++; });
    return map;
  }
  function badgesHTML(a){
    const map = groupBadges(a.badges || []);
    const parts = [];
    BADGE_TYPES.forEach(t=>{
      if(map[t.key]>0){
        parts.push(`<span class="badge-chip" data-type="${t.key}">${t.icon} ${t.label} <span class="count">x${map[t.key]}</span></span>`);
      }
    });
    return parts.join(' ');
  }
  function adjustPointsByBadgeMap(idx, map, sign = +1){
    Object.keys(map).forEach(k=>{
      const inc = (BADGE_POINTS[k] || 0) * (map[k] || 0) * sign;
      if(inc) roster[idx].points = Math.max(0, roster[idx].points + inc);
    });
  }

  function openBadgePicker(anchor, idx){
    const cell = anchor.closest('td'); if(!cell) return;
    closeBadgePicker();
    cell.classList.add('relative');
    const pop = document.createElement('div');
    pop.id = 'c6b-badge-pop';
    pop.className = 'absolute right-0 top-full mt-1 z-50 bg-white shadow-xl border border-gray-200 rounded-xl p-2 w-44';

    BADGE_TYPES.forEach(t=>{
      const b = document.createElement('button');
      b.type = 'button';
      b.className = 'px-3 py-2 rounded hover:bg-gray-100 flex items-center gap-2 w-full text-sm';
      b.innerHTML = `<span>${t.icon}</span><span>${t.label}</span>`;
      b.addEventListener('click', (ev)=>{
        ev.stopPropagation();
        addBadge(idx, t.key);
        closeBadgePicker();
      });
      pop.appendChild(b);
    });

    const hr = document.createElement('div'); hr.className='my-1 border-t border-gray-200'; pop.appendChild(hr);
    const clear = document.createElement('button');
    clear.type='button';
    clear.className='px-3 py-2 rounded bg-amber-50 hover:bg-amber-100 text-amber-700 w-full text-sm';
    clear.textContent='ğŸ§¹ Quitar todas';
    clear.addEventListener('click', (ev)=>{
      ev.stopPropagation();
      const current = groupBadges(roster[idx].badges || []);
      adjustPointsByBadgeMap(idx, current, -1);
      roster[idx].badges = [];
      save(); renderAll(); closeBadgePicker();
    });
    pop.appendChild(clear);

    cell.appendChild(pop);
    const outside = (e)=>{ if(!pop.contains(e.target)){ document.removeEventListener('click', outside); closeBadgePicker(); } };
    setTimeout(()=> document.addEventListener('click', outside), 0);
  }
  function closeBadgePicker(){ const el = document.getElementById('c6b-badge-pop'); if(el) el.remove(); }
  function addBadge(idx, key){
    ensureBadges();
    roster[idx].badges.push(key);
    const inc = BADGE_POINTS[key] || 0;
    if(inc){ roster[idx].points = Math.max(0, roster[idx].points + inc); }
    save(); renderAll();
  }

  /* Estado */
  let roster = load();
  let mvp    = loadMvp();
  ensureBadges();

  /* Render */
  function sortRoster(){ roster.sort((a,b)=> b.points - a.points || a.name.localeCompare(b.name)); }
  function stats(){
    const count = roster.length;
    const total = roster.reduce((s,a)=>s+a.points,0);
    const avg = count? (total/count).toFixed(1) : '0.0';
    const leader = roster[0]? roster[0].name+' ('+roster[0].points+')':'â€”';
    $('#c6b-metric-count').textContent  = count;
    $('#c6b-metric-total').textContent  = total;
    $('#c6b-metric-avg').textContent    = avg;
    $('#c6b-metric-leader').textContent = leader;
  }
  function renderPodium(){
    const p1 = roster[0], p2 = roster[1], p3 = roster[2];
    $('#c6b-p1').textContent  = p1? p1.name : 'â€”';
    $('#c6b-p1p').textContent = p1? p1.points+' pts':'â€” pts';
    $('#c6b-p2').textContent  = p2? p2.name : 'â€”';
    $('#c6b-p2p').textContent = p2? p2.points+' pts':'â€” pts';
    $('#c6b-p3').textContent  = p3? p3.name : 'â€”';
    $('#c6b-p3p').textContent = p3? p3.points+' pts':'â€” pts';
  }
  function renderMvp(){
    if(mvp){ $('#c6b-mvp-name').textContent = mvp.name; $('#c6b-mvp-points').textContent = mvp.points+' pts'; }
    else { $('#c6b-mvp-name').textContent = 'AÃºn sin elegir'; $('#c6b-mvp-points').textContent = 'â€” pts'; }
  }
  function renderSelects(){
    const sel = $('#c6b-quick-student'); if(!sel) return;
    sel.innerHTML = '';
    roster.forEach((a,idx)=>{ const opt=document.createElement('option'); opt.value=idx; opt.textContent=a.name; sel.appendChild(opt); });
  }
  function renderTable(){
    const tbody = $('#c6b-tbody'); if(!tbody) return;
    tbody.innerHTML = '';
    roster.forEach((a,idx)=>{
      const tr = document.createElement('tr');
      tr.className = (mvp && mvp.name===a.name) ? 'bg-amber-50' : '';
      tr.innerHTML = `
        <td class="px-4 py-2 text-sm text-gray-700">${idx+1}</td>
        <td class="px-4 py-2 text-sm font-medium text-gray-900">${a.name}</td>
        <td class="px-4 py-2 text-sm text-gray-700">${a.points}</td>
        <td class="px-4 py-2 text-sm space-x-1">${badgesHTML(a) || '<span class="text-xs text-gray-400">â€”</span>'}</td>
        <td class="px-4 py-2 flex gap-1">
          <button class="btn-primary text-xs px-2 py-1 rounded" data-action="plus" data-index="${idx}">+1</button>
          <button class="bg-red-600 text-white text-xs px-2 py-1 rounded" data-action="minus" data-index="${idx}">-1</button>
          <button class="bg-amber-500 text-white text-xs px-2 py-1 rounded" data-action="star" data-index="${idx}">â­ MVP</button>
          <button class="bg-gray-800 text-white text-xs px-2 py-1 rounded" data-action="badge" data-index="${idx}">ğŸ…</button>
        </td>`;
      tbody.appendChild(tr);
    });
  }
  function renderEditor(){ const ta = $('#c6b-textarea'); if(!ta) return; ta.value = roster.map(a=>a.name).join('\n'); }

  function renderAll(){ sortRoster(); stats(); renderPodium(); renderMvp(); renderSelects(); renderTable(); renderProgress(); }

  /* Eventos */
  $('#c6b-quick-apply')?.addEventListener('click', ()=>{
    const idx = parseInt($('#c6b-quick-student').value,10);
    const delta = parseInt($('#c6b-quick-reason').value,10);
    if(isNaN(idx)||isNaN(delta)) return;
    roster[idx].points = Math.max(0, roster[idx].points + delta);
    save(); renderAll();
  });

  $('#c6b-btn-mvp')?.addEventListener('click', ()=>{
    if(!roster.length) return;
    const idx = Math.floor(Math.random()*roster.length);
    mvp = { name: roster[idx].name, points: roster[idx].points }; saveMvp(mvp); renderAll();
  });

  $('#c6b-btn-clear-mvp')?.addEventListener('click', ()=>{ mvp=null; saveMvp(null); renderAll(); });

  $('#c6b-btn-reset')?.addEventListener('click', ()=>{
    if(confirm('Â¿Seguro que quieres poner a 0 todos los puntos de 6ÂºB?')){
      roster = roster.map(a=>({name:a.name, points:0, badges:[]}));
      mvp=null; save(); saveMvp(null); setLastReset(Date.now()); renderAll();
    }
  });

  $('#c6b-tbody')?.addEventListener('click', (e)=>{
    const btn = e.target.closest('button'); if(!btn) return;
    const idx = parseInt(btn.getAttribute('data-index'),10);
    const action = btn.getAttribute('data-action'); if(Number.isNaN(idx)) return;

    if(action==='plus'){ roster[idx].points = Math.max(0, roster[idx].points + 1); }
    if(action==='minus'){
      roster[idx].points = Math.max(0, roster[idx].points - 1);
      const row = btn.closest('tr'); row?.classList.add('shake'); setTimeout(()=> row?.classList.remove('shake'), 220);
    }
    if(action==='star'){ mvp = { name: roster[idx].name, points: roster[idx].points }; saveMvp(mvp); }
    if(action==='badge'){ openBadgePicker(btn, idx); return; }

    save(); renderAll();
  });

  const editor = $('#c6b-editor');
  $('#c6b-btn-edit')?.addEventListener('click', ()=>{ editor.classList.toggle('hidden'); renderEditor(); });
  $('#c6b-editor-cancel')?.addEventListener('click', ()=> editor.classList.add('hidden'));
  $('#c6b-editor-apply')?.addEventListener('click', ()=>{
    const lines = $('#c6b-textarea').value.split('\n').map(s=>s.trim()).filter(Boolean);
    if(!lines.length) return;
    roster = lines.map(n=>({ name:n, points:0, badges:[] }));
    mvp=null; save(); saveMvp(null); editor.classList.add('hidden'); renderAll();
  });

  const obs = new MutationObserver(()=>{ if(!sec.classList.contains('hidden')) renderAll(); });
  obs.observe(sec, { attributes:true });
  if(!sec.classList.contains('hidden')) renderAll();
})();
</script>
</section>
      <section id="objetivos" class="hidden">
  <style>
    /* Estilos locales SOLO para #objetivos */
    #objetivos .obj-reveal { 
      opacity: 0; transform: translateY(12px) scale(.98);
      transition: all .55s cubic-bezier(.22,.8,.3,1);
    }
    #objetivos .obj-show { opacity: 1; transform: translateY(0) scale(1); }
    #objetivos .card {
      background: linear-gradient(180deg, #ffffff 0%, #f8fafc 100%);
    }
    #objetivos .ring-grad {
  /* Contraste mejorado (fondo claro real) */
  background:
    radial-gradient(1000px 120px at 10% -20%, rgba(99,102,241,.18), transparent 60%),
    radial-gradient(900px 140px at 90% -30%, rgba(37,99,235,.22), transparent 60%),
    linear-gradient(180deg, #f5f7ff 0%, #eef2ff 100%);
  box-shadow: 0 4px 20px rgba(2,6,23,.06);
}
    #objetivos .confetti {
      position: relative; overflow: hidden;
    }
    #objetivos .confetti::after {
      content: "";
      position: absolute; inset: -2px;
      background:
        radial-gradient(6px 6px at 12% 18%, rgba(99,102,241,.25) 40%, transparent 41%) repeat,
        radial-gradient(5px 5px at 78% 22%, rgba(16,185,129,.25) 40%, transparent 41%) repeat,
        radial-gradient(5px 5px at 22% 76%, rgba(244,114,182,.25) 40%, transparent 41%) repeat,
        radial-gradient(6px 6px at 84% 74%, rgba(59,130,246,.25) 40%, transparent 41%) repeat;
      background-size: 160px 160px;
      pointer-events: none; opacity: .7;
    }
  </style>

  <!-- Cabecera decorada -->
 <!-- Cabecera decorada (contraste mejorado) -->
<div class="ring-grad rounded-2xl p-6 md:p-8 mb-6 text-gray-900 relative overflow-hidden border border-indigo-100">
  <div class="absolute -top-10 -right-10 w-40 h-40 rounded-full bg-indigo-500/10 blur-2xl"></div>
  <h3 class="text-3xl md:text-4xl font-extrabold tracking-tight obj-reveal text-slate-900">Objetivos</h3>
  <p class="mt-1 obj-reveal text-slate-600">La base de la Liga: esfuerzo, compaÃ±erismo y constancia.</p>
</div>
  <!-- Cuerpo con animaciones de apariciÃ³n -->
  <div class="grid gap-6">
    <div class="card rounded-2xl p-5 shadow obj-reveal confetti">
      <p class="mb-6">La <strong>Liga Fantasy NSS</strong> es una propuesta de gamificaciÃ³n diseÃ±ada para transformar el dÃ­a a dÃ­a en clase en una experiencia divertida, motivadora y educativa. A travÃ©s de un sistema de puntos y recompensas, se reconoce el esfuerzo, la constancia, el comportamiento positivo y la implicaciÃ³n tanto en el colegio como en casa.</p>
      <p class="mb-6">Cada alumno puede ir sumando puntos a lo largo de la semana por cumplir tareas, participar en clase, ayudar a los compaÃ±eros o mostrar una actitud ejemplar. La idea es que entiendan que su trabajo diario y su compromiso tienen valor, y que ese valor se traduce en recompensas simbÃ³licas que fomentan la responsabilidad y el compaÃ±erismo.</p>
      <p class="mb-6">El objetivo no es competir contra los demÃ¡s, sino superarse a uno mismo y formar parte de un equipo donde todos suman. De este modo, se refuerza el aprendizaje, el esfuerzo personal y el clima positivo en el aula.</p>
    </div>

    <div class="card rounded-2xl p-5 shadow obj-reveal">
      <h4 class="text-xl font-bold mb-3 flex items-center gap-2">
        <span class="inline-flex w-8 h-8 items-center justify-center rounded-full bg-indigo-600 text-white">ğŸ¯</span>
        Sistema de puntuaciÃ³n
      </h4>
      <ul class="list-disc pl-5 space-y-1">
        <li>ğŸ“– <strong>Leer un libro extra:</strong> +3 puntos</li>
        <li>ğŸ“š <strong>Entrega de tareas:</strong> +1 punto</li>
        <li>ğŸ™Œ <strong>Buena acciÃ³n o ayuda en clase:</strong> +1 punto</li>
        <li>âŒ <strong>Falta de trabajo:</strong> -1 punto</li>
        <li>ğŸš« <strong>Incidencia grave:</strong> -3 puntos</li>
      </ul>

      <!-- Chips decorativos (no cambian el contenido, solo estÃ©tica) -->
      <div class="mt-4 flex flex-wrap gap-2">
        <span class="px-3 py-1 text-xs rounded-full bg-indigo-50 text-indigo-700 border border-indigo-200">Constancia</span>
        <span class="px-3 py-1 text-xs rounded-full bg-emerald-50 text-emerald-700 border border-emerald-200">Trabajo en equipo</span>
        <span class="px-3 py-1 text-xs rounded-full bg-amber-50 text-amber-700 border border-amber-200">AutonomÃ­a</span>
        <span class="px-3 py-1 text-xs rounded-full bg-pink-50 text-pink-700 border border-pink-200">Actitud positiva</span>
      </div>
    </div>
  </div>

  <!-- Script de apariciÃ³n progresiva SOLO cuando la secciÃ³n estÃ¡ visible -->
  <script>
    (function(){
      const sec = document.getElementById('objetivos');
      function reveal(){
        const items = sec.querySelectorAll('.obj-reveal');
        items.forEach((el, i)=> setTimeout(()=> el.classList.add('obj-show'), 90*i));
      }
      const mo = new MutationObserver(()=>{ if(!sec.classList.contains('hidden')) reveal(); });
      mo.observe(sec, { attributes:true });
      if(!sec.classList.contains('hidden')) reveal();
    })();
  </script>
</section>
<section id="recompensas" class="hidden">
  <style>
    /* Estilos locales SOLO para #recompensas */
    #recompensas .rec-reveal { 
      opacity: 0; transform: translateY(12px);
      transition: all .5s cubic-bezier(.22,.8,.3,1);
    }
    #recompensas .rec-show { opacity: 1; transform: translateY(0); }
    #recompensas .grad-wrap {
      background: linear-gradient(180deg, #eef2ff 0%, #f0f9ff 100%);
    }
    /* Colores de borde por fila (manteniendo tu contenido intacto) */
    #recompensas tbody tr:nth-child(1){ border-left: 4px solid #f59e0b; } /* oro */
    #recompensas tbody tr:nth-child(2){ border-left: 4px solid #9ca3af; } /* plata */
    #recompensas tbody tr:nth-child(3){ border-left: 4px solid #fb923c; } /* bronce */
    #recompensas tbody tr:nth-child(4){ border-left: 4px solid #3b82f6; }
    #recompensas tbody tr:nth-child(5){ border-left: 4px solid #fbbf24; }
    #recompensas tbody tr:nth-child(6){ border-left: 4px solid #10b981; }
    #recompensas .table-wrap { 
      border-radius: 1rem; overflow: hidden; 
      box-shadow: 0 6px 18px rgba(2,6,23,.08);
    }
    #recompensas table tbody tr:hover { background: #fffbeb; } /* sutil hover */
  </style>

  <!-- Cabecera con gradiente -->
  <div class="grad-wrap rounded-2xl p-6 md:p-8 mb-6 relative">
    <h3 class="text-3xl md:text-4xl font-extrabold text-gray-900 rec-reveal"> Recompensas â€“ Liga Fantasy NSS</h3>
    <p class="text-gray-600 mt-1 rec-reveal">Premiamos el esfuerzo sostenido y la actitud positiva en el aula.</p>
    <div class="absolute -right-6 -top-6 w-24 h-24 rounded-full bg-white/40 blur-xl"></div>
  </div>

  <div class="rec-reveal">
    <p class="mb-6 text-gray-700">Estas recompensas estÃ¡n diseÃ±adas para premiar el esfuerzo, la constancia y el comportamiento positivo en el aula. Se otorgan segÃºn el puesto que ocupen en el ranking de la liga.</p>

    <div class="overflow-x-auto table-wrap bg-white">
      <table class="min-w-full">
        <thead class="bg-gray-900 text-white">
          <tr>
            <th class="p-3 text-left">ğŸ… Puesto</th>
            <th class="p-3 text-left">ğŸ Recompensa</th>
          </tr>
        </thead>
        <tbody class="divide-y divide-gray-200">
          <tr><td class="p-3">ğŸ¥‡ 1Âº al 3Âº</td><td class="p-3">ğŸŸ¨ <strong>COMODÃN EXAMEN</strong> â†’ Puede pedir ayuda al profesor en una pregunta del examen.</td></tr>
          <tr><td class="p-3">ğŸ¥ˆ 4Âº al 6Âº</td><td class="p-3">â±ï¸ <strong>+5 minutos extra</strong> para terminar un examen.</td></tr>
          <tr><td class="p-3">ğŸ¥‰ 7Âº al 10Âº</td><td class="p-3">ğŸª‘ <strong>Elige su sitio</strong> en clase durante 3 dÃ­as.</td></tr>
          <tr><td class="p-3">ğŸŸ¦ 11Âº al 15Âº</td><td class="p-3">âœ… <strong>Un positivo</strong> extra en el Ã¡rea que elija.</td></tr>
          <tr><td class="p-3">ğŸŸ¨ 16Âº al 20Âº</td><td class="p-3">âŒ <strong>Quitar un negativo</strong> de cualquier Ã¡rea.</td></tr>
          <tr><td class="p-3">ğŸŸ© 21Âº al 25Âº</td><td class="p-3">ğŸ–ï¸ <strong>Responsable de material</strong> por un dÃ­a (reparto, organizaciÃ³n, ayuda en clase).</td></tr>
        </tbody>
      </table>
    </div>

    <!-- PÃ­ldoras informativas (solo estilo/decoraciÃ³n) -->
    <div class="mt-4 flex flex-wrap gap-2">
      <span class="px-3 py-1 text-xs rounded-full bg-amber-50 text-amber-700 border border-amber-200">Reconocimiento</span>
      <span class="px-3 py-1 text-xs rounded-full bg-blue-50 text-blue-700 border border-blue-200">Responsabilidad</span>
      <span class="px-3 py-1 text-xs rounded-full bg-emerald-50 text-emerald-700 border border-emerald-200">MotivaciÃ³n</span>
    </div>
  </div>

  <!-- AnimaciÃ³n de apariciÃ³n SOLO cuando la secciÃ³n estÃ¡ visible -->
  <script>
    (function(){
      const sec = document.getElementById('recompensas');
      function reveal(){
        const items = sec.querySelectorAll('.rec-reveal');
        items.forEach((el, i)=> setTimeout(()=> el.classList.add('rec-show'), 100*i));
      }
      const mo = new MutationObserver(()=>{ if(!sec.classList.contains('hidden')) reveal(); });
      mo.observe(sec, { attributes:true });
      if(!sec.classList.contains('hidden')) reveal();
    })();
  </script>
</section>
          <section id="entrevistas" class="hidden">
  <style>
    /* Estilos locales SOLO para #entrevistas */
    #entrevistas .e-hero{
      background: radial-gradient(1200px 200px at -10% -40%, rgba(99,102,241,.15), transparent 60%),
                  radial-gradient(900px 150px at 110% -30%, rgba(16,185,129,.18), transparent 60%),
                  linear-gradient(180deg,#ffffff 0%,#f8fafc 100%);
    }
    #entrevistas .e-chip{ font-size:.70rem }
    #entrevistas .e-card{
      background: linear-gradient(180deg,#ffffff 0%,#f9fafb 100%);
      transition: transform .2s ease, box-shadow .2s ease;
    }
    #entrevistas .e-card:hover{ transform: translateY(-2px); box-shadow: 0 10px 20px rgba(2,6,23,.08); }
    #entrevistas .e-reveal{ opacity:0; transform: translateY(10px); transition: all .45s cubic-bezier(.22,.8,.3,1); }
    #entrevistas .e-show{ opacity:1; transform: translateY(0); }

    /* Modal */
    #entrevistas .e-modal{ display:none; position: fixed; inset:0; background: rgba(15,23,42,.55); z-index: 50; }
    #entrevistas .e-modal.open{ display:flex; align-items:center; justify-content:center; }
    #entrevistas .e-modal-card{ width: min(750px, 92vw); max-height: 90vh; overflow:auto; }
    #entrevistas .e-input{ border:1px solid #e5e7eb; border-radius:.75rem; padding:.6rem .8rem; width:100%; }
    #entrevistas .e-label{ font-size:.85rem; color:#334155; margin-bottom:.25rem; display:block; }

    /* Lightbox simple */
    #entrevistas .e-lightbox{ display:none; position:fixed; inset:0; background: rgba(0,0,0,.85); z-index:60; }
    #entrevistas .e-lightbox.open{ display:flex; align-items:center; justify-content:center; }
    #entrevistas .e-lightbox img{ max-width:90vw; max-height:85vh; border-radius:1rem; }

    /* Badges por clase */
    #entrevistas .badge-5a{ background:#e0e7ff; color:#3730a3; }
    #entrevistas .badge-5b{ background:#d1fae5; color:#065f46; }
    #entrevistas .badge-6a{ background:#fae8ff; color:#86198f; }
    #entrevistas .badge-6b{ background:#e0f2fe; color:#075985; }

    /* MVP suggestion pill */
    #entrevistas .mvp-pill{ border:1px solid #e5e7eb; background:#ffffff; }
    #entrevistas .mvp-pill strong{ color:#0f172a; }
  </style>

  <!-- Cabecera -->
  <div class="e-hero rounded-2xl p-6 md:p-8 mb-6 relative overflow-hidden">
    <div class="absolute -top-8 -right-10 w-44 h-44 rounded-full bg-white/30 blur-2xl"></div>
    <h3 class="text-3xl md:text-4xl font-extrabold text-gray-900 e-reveal">GalerÃ­a y Entrevistas</h3>
    <p class="text-gray-600 mt-1 e-reveal">Recoge momentos, actividades y frases destacadas de tus estudiantes.</p>

    <!-- Controles -->
    <div class="mt-4 flex flex-col md:flex-row gap-2 e-reveal">
      <div class="flex gap-2 items-center">
        <input id="e-search" type="search" placeholder="Buscar por nombre o actividadâ€¦" class="e-input">
        <select id="e-filter-class" class="e-input">
          <option value="all">Todas las clases</option>
          <option value="5A">5ÂºA</option>
          <option value="5B">5ÂºB</option>
          <option value="6A">6ÂºA</option>
          <option value="6B">6ÂºB</option>
        </select>
      </div>
      <div class="flex gap-2 md:ml-auto">
        <button id="e-btn-add" class="px-4 py-2 rounded-xl bg-indigo-600 hover:bg-indigo-700 text-white shadow">â• Nueva entrada</button>
        <button id="e-btn-clear" class="px-4 py-2 rounded-xl bg-gray-200 hover:bg-gray-300 text-gray-800">ğŸ§¹ Limpiar (demo)</button>
      </div>
    </div>
  </div>

  <!-- MVP detectados (importaciÃ³n rÃ¡pida) -->
  <div id="e-mvp-bar" class="hidden mb-4 rounded-2xl border p-4 bg-white">
    <div class="flex items-center justify-between gap-2 flex-wrap">
      <div class="flex items-center gap-2">
        <span class="text-sm font-semibold text-gray-700">MVP detectados:</span>
        <div id="e-mvp-pills" class="flex flex-wrap gap-2"></div>
      </div>
      <div class="flex gap-2">
        <button id="e-btn-import-all" class="px-3 py-2 rounded-lg bg-emerald-600 text-white hover:bg-emerald-700">Importar todos</button>
        <button id="e-btn-refresh-mvps" class="px-3 py-2 rounded-lg bg-gray-100 hover:bg-gray-200">Actualizar</button>
      </div>
    </div>
  </div>

  <!-- Grid -->
  <div id="e-grid" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-4"></div>

  <!-- Estado vacÃ­o -->
  <div id="e-empty" class="hidden rounded-2xl border border-dashed border-gray-300 p-10 text-center text-gray-500">
    Sin entradas todavÃ­a. Pulsa <strong>â€œNueva entradaâ€</strong> o <strong>â€œImportar todosâ€</strong> para traer los MVP ğŸ‘‡
  </div>

  <!-- Modal: Crear entrada -->
  <div id="e-modal" class="e-modal">
    <div class="e-modal-card bg-white rounded-2xl shadow-xl p-5">
      <div class="flex items-center justify-between mb-3">
        <h4 class="text-xl font-bold">Nueva entrada</h4>
        <button id="e-modal-close" class="px-3 py-1 rounded-lg bg-gray-100 hover:bg-gray-200">âœ–</button>
      </div>

      <div class="grid md:grid-cols-2 gap-4">
        <div>
          <label class="e-label">Nombre del alumno/a</label>
          <input id="e-form-name" class="e-input" placeholder="Ej.: SofÃ­a R." maxlength="60">
        </div>
        <div>
          <label class="e-label">Clase</label>
          <select id="e-form-class" class="e-input">
            <option value="5A">5ÂºA</option>
            <option value="5B">5ÂºB</option>
            <option value="6A">6ÂºA</option>
            <option value="6B">6ÂºB</option>
          </select>
        </div>
        <div class="md:col-span-2">
          <label class="e-label">Actividad / TÃ­tulo breve</label>
          <input id="e-form-title" class="e-input" placeholder="Ej.: Experimento de ciencias">
        </div>
        <div class="md:col-span-2">
          <label class="e-label">Entrevista / Cita destacada</label>
          <textarea id="e-form-quote" rows="4" class="e-input" placeholder="Ej.: â€œLo mÃ¡s difÃ­cil fueâ€¦ pero lo conseguimosâ€"></textarea>
        </div>

        <div>
          <label class="e-label">Foto (archivo)</label>
          <input id="e-form-file" type="file" accept="image/*" class="e-input" />
          <p class="text-xs text-gray-500 mt-1">Puedes usar la cÃ¡mara del mÃ³vil.</p>
        </div>
        <div>
          <label class="e-label">â€¦o URL de imagen</label>
          <input id="e-form-url" class="e-input" placeholder="https://â€¦">
          <p class="text-xs text-gray-500 mt-1">Si pegas una URL, tendrÃ¡ prioridad sobre el archivo.</p>
        </div>
      </div>

      <div class="mt-4 flex items-center justify-between">
        <p class="text-xs text-gray-500">Las entradas se guardan en este dispositivo (localStorage).</p>
        <div class="flex gap-2">
          <button id="e-modal-save" class="px-4 py-2 rounded-xl bg-emerald-600 hover:bg-emerald-700 text-white">Guardar</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Lightbox -->
  <div id="e-lightbox" class="e-lightbox">
    <div class="absolute top-4 right-4 flex gap-2">
      <button id="e-lightbox-delete" class="px-3 py-1 rounded-lg bg-red-600 text-white">Eliminar</button>
      <button id="e-lightbox-close" class="px-3 py-1 rounded-lg bg-gray-200">Cerrar</button>
    </div>
    <img id="e-lightbox-img" alt="Foto" />
  </div>

  <script>
    (function(){
      const sec = document.getElementById('entrevistas');
      const KEY = 'fantasy_media_v1';
      const MVP_KEYS = {
        '5A': 'fantasy_5a_mvp_v1',
        '5B': 'fantasy_5b_mvp_v1',
        '6A': 'fantasy_6a_mvp_v1',
        '6B': 'fantasy_6b_mvp_v1',
      };

      // Imagen por defecto para MVP
      const DEFAULT_MVP_IMG = 'https://images.unsplash.com/photo-1530224264768-7ff8c1789d79?q=80&w=1200&auto=format&fit=crop';

      const $ = (sel)=> sec.querySelector(sel);
      const grid = $('#e-grid');
      const empty = $('#e-empty');

      let entries = [];

      function load(){
        try{ const raw = localStorage.getItem(KEY); if(raw) return JSON.parse(raw); }catch(e){}
        // Demo inicial (solo si no hay datos guardados)
        return [
          {
            id: crypto.randomUUID(), name:'Sergio', clazz:'5A',
            title:'Gymkana de mates', quote:'â€œÂ¡Hicimos equipo y nos saliÃ³ perfecto!â€',
            img:'https://images.unsplash.com/photo-1606326608606-aa0b62935f22?q=80&w=1200&auto=format&fit=crop',
            ts: Date.now()-86400000*2
          },
          {
            id: crypto.randomUUID(), name:'LucÃ­a', clazz:'5B',
            title:'Taller de lectura', quote:'â€œLeÃ­mos en voz alta y me encantÃ³ hacer de narradora.â€',
            img:'https://images.unsplash.com/photo-1544642899-f836b6f1df2b?q=80&w=1200&auto=format&fit=crop',
            ts: Date.now()-86400000*1.3
          },
          {
            id: crypto.randomUUID(), name:'Iker', clazz:'6A',
            title:'VolcÃ¡n de quÃ­mica', quote:'â€œLa erupciÃ³n fue Ã©pica y aprendimos un montÃ³n.â€',
            img:'https://images.unsplash.com/photo-1532094349884-543bc11b234d?q=80&w=1200&auto=format&fit=crop',
            ts: Date.now()-3600000*8
          }
        ];
      }
      function save(){ localStorage.setItem(KEY, JSON.stringify(entries)); }

      function classBadge(c){
        const map = { '5A':'badge-5a', '5B':'badge-5b', '6A':'badge-6a', '6B':'badge-6b' };
        return `<span class="e-chip px-2 py-1 rounded-full ${map[c]||'badge-5a'}">${c}</span>`;
      }

      function formatDate(ts){
        const d = new Date(ts);
        return d.toLocaleDateString('es-ES', { day:'2-digit', month:'short', year:'numeric' });
      }

      function cardHTML(item){
        return `
          <article class="e-card rounded-2xl shadow p-3 e-reveal" data-id="${item.id}">
            <div class="relative rounded-xl overflow-hidden aspect-[4/3] bg-gray-100">
              <img src="${item.img}" alt="${item.title||'Actividad'}" class="w-full h-full object-cover">
              <div class="absolute top-2 left-2 flex gap-2">${classBadge(item.clazz)}</div>
              <button class="absolute bottom-2 right-2 px-3 py-1 rounded-lg bg-white/90 text-gray-800 text-sm e-btn-zoom">Ampliar</button>
            </div>
            <div class="mt-3">
              <h5 class="font-semibold text-gray-900">${item.title||'Actividad'}</h5>
              <p class="text-sm text-gray-500">${item.name} Â· <span>${formatDate(item.ts)}</span></p>
              ${item.quote ? `<p class="mt-2 text-gray-700">â€œ${item.quote}â€</p>`:''}
              <div class="mt-3 flex gap-2">
                <button class="px-3 py-1 rounded-lg bg-gray-200 hover:bg-gray-300 text-gray-800 text-sm e-btn-delete">Eliminar</button>
              </div>
            </div>
          </article>
        `;
      }

      function render(){
        const q = $('#e-search').value.trim().toLowerCase();
        const f = $('#e-filter-class').value;

        const filtered = entries
          .filter(it => f==='all' ? true : it.clazz===f)
          .filter(it => {
            const blob = (it.name+' '+(it.title||'')+' '+(it.quote||'')).toLowerCase();
            return blob.includes(q);
          })
          .sort((a,b)=> b.ts - a.ts);

        grid.innerHTML = filtered.map(cardHTML).join('');
        empty.classList.toggle('hidden', filtered.length>0);

        // animaciÃ³n de apariciÃ³n
        requestAnimationFrame(()=> {
          grid.querySelectorAll('.e-reveal').forEach((el,i)=> setTimeout(()=> el.classList.add('e-show'), 60*i));
        });
      }

      // --- MVP import: lectura de MVPs guardados por clase ---
      function readMVPs(){
        const out = [];
        for(const [clazz, key] of Object.entries(MVP_KEYS)){
          try{
            const raw = localStorage.getItem(key);
            if(!raw) continue;
            const obj = JSON.parse(raw); // {name, points}
            if(obj && obj.name) out.push({ clazz, name: obj.name, points: obj.points||0 });
          }catch(e){}
        }
        return out;
      }

      function makeMvpPill(mvp){
        const id = `pill-${mvp.clazz}`;
        return `
          <div class="mvp-pill px-3 py-1 rounded-xl flex items-center gap-2" id="${id}">
            <span class="e-chip px-2 py-1 rounded-full ${{
              '5A':'badge-5a','5B':'badge-5b','6A':'badge-6a','6B':'badge-6b'
            }[mvp.clazz]}">${mvp.clazz}</span>
            <strong>${mvp.name}</strong>
            <span class="text-xs text-gray-500">${mvp.points} pts</span>
            <button class="px-2 py-1 rounded bg-emerald-600 text-white text-xs e-btn-import-one" data-clazz="${mvp.clazz}">AÃ±adir</button>
          </div>
        `;
      }

      function refreshMvpBar(){
        const mvps = readMVPs();
        const bar = $('#e-mvp-bar');
        const pills = $('#e-mvp-pills');
        if(mvps.length){
          bar.classList.remove('hidden');
          pills.innerHTML = mvps.map(makeMvpPill).join('');
        }else{
          bar.classList.add('hidden');
          pills.innerHTML = '';
        }
      }

      function addMvpToGallery(mvp){
        const item = {
          id: crypto.randomUUID(),
          name: mvp.name,
          clazz: mvp.clazz,
          title: 'MVP de la semana',
          quote: `Reconocido/a como MVP con ${mvp.points} puntos.`,
          img: DEFAULT_MVP_IMG,
          ts: Date.now()
        };
        entries.push(item);
        save();
        render();
      }

      // Modal helpers
      const modal = $('#e-modal');
      const lb = $('#e-lightbox');
      const lbImg = $('#e-lightbox-img');
      let lbId = null;

      function openModal(){ modal.classList.add('open'); }
      function closeModal(){ modal.classList.remove('open'); clearForm(); }
      function clearForm(){
        $('#e-form-name').value='';
        $('#e-form-class').value='5A';
        $('#e-form-title').value='';
        $('#e-form-quote').value='';
        $('#e-form-file').value='';
        $('#e-form-url').value='';
      }

      // Guardar nueva entrada
      async function getImageData(){
        const url = $('#e-form-url').value.trim();
        if(url) return url;
        const file = $('#e-form-file').files[0];
        if(!file) return '';
        return new Promise((res,rej)=>{
          const fr = new FileReader();
          fr.onload = ()=> res(fr.result);
          fr.onerror = rej;
          fr.readAsDataURL(file);
        });
      }

      $('#e-btn-add').addEventListener('click', openModal);
      $('#e-modal-close').addEventListener('click', closeModal);

      $('#e-modal-save').addEventListener('click', async ()=>{
        const name = $('#e-form-name').value.trim();
        const clazz = $('#e-form-class').value;
        const title = $('#e-form-title').value.trim();
        const quote = $('#e-form-quote').value.trim();
        const img = await getImageData();

        if(!name || !clazz || !img){
          alert('Nombre, clase y foto/URL son obligatorios.');
          return;
        }

        entries.push({ id: crypto.randomUUID(), name, clazz, title, quote, img, ts: Date.now() });
        save();
        closeModal();
        render();
      });

      // Grid interactions (delegaciÃ³n)
      grid.addEventListener('click', (e)=>{
        const card = e.target.closest('article.e-card');
        if(!card) return;
        const id = card.getAttribute('data-id');
        if(e.target.classList.contains('e-btn-delete')){
          if(confirm('Â¿Eliminar esta entrada de la galerÃ­a?')){
            entries = entries.filter(it => it.id!==id);
            save(); render();
          }
          return;
        }
        if(e.target.classList.contains('e-btn-zoom')){
          const it = entries.find(x => x.id===id);
          if(!it) return;
          lbImg.src = it.img; lb.classList.add('open'); lbId = id;
        }
      });

      $('#e-lightbox-close').addEventListener('click', ()=> lb.classList.remove('open'));
      $('#e-lightbox').addEventListener('click', (e)=> { if(e.target===lb) lb.classList.remove('open'); });

      $('#e-lightbox-delete').addEventListener('click', ()=>{
        if(!lbId) return;
        if(confirm('Â¿Eliminar esta entrada?')){
          entries = entries.filter(it => it.id!==lbId);
          save(); lb.classList.remove('open'); render();
        }
      });

      // Filtros / bÃºsqueda
      $('#e-search').addEventListener('input', render);
      $('#e-filter-class').addEventListener('change', render);

      // Limpiar (demo): restaura estado vacÃ­o
      $('#e-btn-clear').addEventListener('click', ()=>{
        if(confirm('Esto borrarÃ¡ las entradas de la galerÃ­a en este dispositivo.')){
          entries = []; save(); render();
        }
      });

      // MVP import events
      $('#e-btn-refresh-mvps').addEventListener('click', refreshMvpBar);
      $('#e-btn-import-all').addEventListener('click', ()=>{
        const mvps = readMVPs();
        if(!mvps.length){ alert('No hay MVP guardados en las clases.'); return; }
        mvps.forEach(addMvpToGallery);
      });
      // delegaciÃ³n para "AÃ±adir" individual
      $('#e-mvp-pills').addEventListener('click', (e)=>{
        const btn = e.target.closest('.e-btn-import-one');
        if(!btn) return;
        const clazz = btn.getAttribute('data-clazz');
        const key = MVP_KEYS[clazz];
        try{
          const raw = localStorage.getItem(key);
          if(!raw){ alert('No se encontrÃ³ MVP para '+clazz); return; }
          const mvp = JSON.parse(raw);
          addMvpToGallery({ clazz, name: mvp.name, points: mvp.points||0 });
        }catch(err){
          alert('No se pudo importar el MVP de '+clazz);
        }
      });

      // Render SOLO cuando la secciÃ³n estÃ© visible
      function revealHeader(){
        const headEls = sec.querySelectorAll('.e-hero .e-reveal');
        headEls.forEach((el,i)=> setTimeout(()=> el.classList.add('e-show'), 90*i));
      }
      const obs = new MutationObserver(()=>{
        if(!sec.classList.contains('hidden')) { revealHeader(); render(); refreshMvpBar(); }
      });
      obs.observe(sec, { attributes:true });

      // Init
      entries = load();
      if(!sec.classList.contains('hidden')) { revealHeader(); render(); refreshMvpBar(); }
    })();
  </script>
</section>
    </main>
  </div>

  <script>
    function startApp(){
      document.getElementById('intro').classList.add('hidden');
      document.getElementById('mainApp').classList.remove('hidden');
      document.getElementById('selector').classList.remove('hidden');
      document.getElementById('nav-top').classList.add('hidden');
    }

    function showSection(sec){
      document.querySelectorAll('main > section').forEach(s=>s.classList.add('hidden'));
      document.getElementById('selector').classList.add('hidden');
      document.getElementById('nav-top').classList.remove('hidden');
      document.getElementById(sec).classList.remove('hidden');
    }

    function goHome(){
      document.querySelectorAll('main > section').forEach(s=>s.classList.add('hidden'));
      document.getElementById('selector').classList.remove('hidden');
      document.getElementById('nav-top').classList.add('hidden');
    }
  </script>
<!-- === Cloud Sync simple (Supabase + localStorage) === -->
<script type="module">
// --- Supabase config ---
const TABLE   = 'fantasy_state';
const ROW_ID  = 'singleton';
const METAKEY = 'fantasy_meta_v1';

// --- Flags globales ---
let isApplyingFromCloud = false;
let isInternalWrite     = false;
let isSavingToCloud     = false;

// --- Helpers de fecha local ---
function setMetaSilently(ts){
  isInternalWrite = true;
  try { localStorage.setItem(METAKEY, String(ts)); }
  finally { isInternalWrite = false; }
}
function getLocalTimestamp(){
  const v = localStorage.getItem(METAKEY);
  return v ? parseInt(v, 10) : 0;
}
function bumpLocalTimestamp(){
  setMetaSilently(Date.now());
}

// --- UI de sincronizaciÃ³n: barra + botones ---
function ensureUI(){
  const headerRow = document.querySelector('header .max-w-6xl');
  if (!headerRow || document.getElementById('cloudStatusBar')) return;

  const right = document.createElement('div');
  right.className = 'flex items-center gap-2';
  right.innerHTML = `
    <button id="saveNowBtn" class="bg-indigo-600 text-white text-sm px-3 py-1 rounded hover:bg-indigo-700 transition">
      Guardar ahora
    </button>
    <button id="syncBtn" class="bg-emerald-600 text-white text-sm px-3 py-1 rounded hover:bg-emerald-700 transition">
      Sincronizar ahora
    </button>`;
  headerRow.appendChild(right);

  document.getElementById('syncBtn')?.addEventListener('click', manualSync);
  document.getElementById('saveNowBtn')?.addEventListener('click', async () => {
    try { bumpLocalTimestamp(); await saveToCloud(); }
    catch (e) { console.warn(e); tempStatus('âŒ Error al guardar ahora', 'error', 2500); }
  });

  const statusBar = document.createElement('div');
  statusBar.id = 'cloudStatusBar';
  statusBar.style.position = 'fixed';
  statusBar.style.top = '56px';
  statusBar.style.left = '0';
  statusBar.style.right = '0';
  statusBar.style.zIndex = '50';
  statusBar.style.pointerEvents = 'none';
  statusBar.style.transition = 'opacity .25s ease';
  statusBar.style.opacity = '0';
  statusBar.className = 'text-sm px-4 py-2 text-center';
  document.body.appendChild(statusBar);
}
function statusEl(){ return document.getElementById('cloudStatusBar'); }
function showStatus(msg, type='info'){
  const el = statusEl(); if (!el) return;
  const styles = {
    info:  'bg-yellow-100 text-yellow-900',
    ok:    'bg-green-100 text-green-900',
    error: 'bg-red-100 text-red-900'
  };
  el.className = `text-sm px-4 py-2 text-center ${styles[type] || styles.info}`;
  el.textContent = msg;
  el.style.opacity = '1';
}
function tempStatus(msg, type='ok', ms=1500){
  showStatus(msg, type);
  setTimeout(() => { const el = statusEl(); if (el) el.style.opacity = '0'; }, ms);
}

// --- Claves de localStorage agrupadas ---
const KEYS = {
  rosters: {
    '5A': 'fantasy_5a_roster_v1',
    '5B': 'fantasy_5b_roster_v1',
    '6A': 'fantasy_6a_roster_v1',
    '6B': 'fantasy_6b_roster_v1',
  },
  mvp: {
    '5A': 'fantasy_5a_mvp_v1',
    '5B': 'fantasy_5b_mvp_v1',
    '6A': 'fantasy_6a_mvp_v1',
    '6B': 'fantasy_6b_mvp_v1',
  },
  resets: {
    '5A': 'fantasy_5a_last_reset_v1',
    '5B': 'fantasy_5b_last_reset_v1',
    '6A': 'fantasy_6a_last_reset_v1',
    '6B': 'fantasy_6b_last_reset_v1',
  },
  media: 'fantasy_media_v1'
};
const jget = (k, def=null) => { try{ const raw = localStorage.getItem(k); return raw ? JSON.parse(raw) : def; }catch{ return def; } };
const jset = (k, v) => localStorage.setItem(k, JSON.stringify(v));

// --- Recolectar y aplicar estado ---
function collectLocalState(){
  const out = {
    v:2,
    _meta: { updatedAt: new Date(getLocalTimestamp() || Date.now()).toISOString() },
    rosters: {}, mvp: {}, resets: {},
    media: jget(KEYS.media, [])
  };
  for(const [clazz, key] of Object.entries(KEYS.rosters)) out.rosters[clazz] = jget(key, []);
  for(const [clazz, key] of Object.entries(KEYS.mvp))     out.mvp[clazz]     = jget(key, null);
  for(const [clazz, key] of Object.entries(KEYS.resets))  out.resets[clazz]  = jget(key, null);
  return out;
}
function applyStateToLocal(state){
  if (!state) return;
  isApplyingFromCloud = true;
  const s = state;
  if (s.rosters) for(const [clazz,key] of Object.entries(KEYS.rosters)) jset(key, s.rosters[clazz]||[]);
  if (s.mvp)     for(const [clazz,key] of Object.entries(KEYS.mvp))     jset(key, s.mvp[clazz]||null);
  if (s.resets)  for(const [clazz,key] of Object.entries(KEYS.resets))  jset(key, s.resets[clazz]||null);
  if (Array.isArray(s.media)) jset(KEYS.media, s.media);
  bumpLocalTimestamp();
  isApplyingFromCloud = false;

  const visible = Array.from(document.querySelectorAll('main > section')).find(s => !s.classList.contains('hidden'));
  if (visible) window.showSection(visible.id);
}

// --- Cloud I/O ---
async function loadCloudRow(){
  const { data, error } = await supa.from(TABLE).select('data, updated_at').eq('id', ROW_ID).maybeSingle();
  if (error) throw error;
  return data;
}
async function saveToCloud(){
  if (isSavingToCloud) return;
  isSavingToCloud = true;
  try{
    showStatus('Guardando en la nubeâ€¦','info');
    const snapshot = collectLocalState();
    const { error } = await supa.from(TABLE).upsert({
      id: ROW_ID,
      data: snapshot,
      updated_at: new Date().toISOString()
    }).eq('id', ROW_ID);
    if (error) throw error;
    setMetaSilently(Date.now());
    tempStatus('ğŸ’¾ Cambios guardados en la nube','ok');
  } catch(err){
    console.warn('Supabase save error', err);
    tempStatus('âŒ Error al guardar en la nube. Copia local activa.','error', 2500);
  } finally {
    isSavingToCloud = false;
  }
}
async function reconcile(){
  showStatus('Sincronizandoâ€¦','info');
  const localTs = getLocalTimestamp();
  const cloud = await loadCloudRow();
  if (!cloud){
    await saveToCloud();
    tempStatus('âœ… Nube inicializada con tus datos locales','ok');
    return;
  }
  const cloudData = cloud.data || {};
  const cloudTs = new Date(cloud.updated_at || cloudData._meta?.updatedAt || 0).getTime();
  if (localTs >= cloudTs){
    await saveToCloud();
    tempStatus('â˜ï¸ Cambios locales subidos a la nube','ok');
  } else {
    isApplyingFromCloud = true;
    try {
      applyStateToLocal(cloudData);
      setMetaSilently(cloudTs || Date.now());
    } finally {
      isApplyingFromCloud = false;
    }
    tempStatus('â¬‡ï¸ Datos mÃ¡s recientes descargados de la nube','ok');
  }
}

// --- Interceptor de cambios locales ---
(function interceptLocalStorage(){
  const origSet = localStorage.setItem.bind(localStorage);
  localStorage.setItem = function(k, v){
    let prev = null;
    try { prev = localStorage.getItem(k); } catch {}
    const r = origSet(k, v);
    if (isApplyingFromCloud || isInternalWrite) return r;
    if (k && k.startsWith('fantasy_') && k !== METAKEY && prev !== v) {
      if (!isSavingToCloud) setMetaSilently(Date.now());
      saveToCloudDebounced();
    }
    return r;
  };
})();

// --- Guardado retardado tras cambios ---
let saveTimer = null;
function saveToCloudDebounced(){
  clearTimeout(saveTimer);
  saveTimer = setTimeout(saveToCloud, 1200);
}

// --- BotÃ³n manual ---
async function manualSync(){
  try { await reconcile(); }
  catch(e){
    console.warn(e);
    tempStatus('âŒ Error de sincronizaciÃ³n manual','error', 2500);
  }
}

// --- Al arrancar: sincroniza y lanza app ---
document.addEventListener('DOMContentLoaded', ensureUI);
(function hookStart(){
  const orig = window.startApp;
  window.startApp = async function(){
    ensureUI();
    try {
      await supa.from(TABLE).select('id').limit(1);
      await reconcile();
    } catch (e) {
      console.warn('No se pudo sincronizar al inicio (Â¿proyecto pausado?)', e);
      tempStatus('âš ï¸ Nube no disponible. Usando copia local.','error', 3000);
    }
    orig();
  };
})();

// --- Guardado al salir/cambiar de pestaÃ±a ---
window.addEventListener('beforeunload', () => { try { saveToCloud(); } catch {} });
document.addEventListener('visibilitychange', () => {
  if (document.hidden) { try { saveToCloud(); } catch {} }
});
</script>
</body>
</html>
